# niftyreg container test suite
# Tests for NiftyReg v1.4.0 - Medical Image Registration Toolkit
#
# NiftyReg contains tools for rigid, affine, and non-linear registration of 2D/3D images.
# Main commands:
#   - reg_aladin: Block-matching rigid/affine registration
#   - reg_f3d: Free-form deformation non-rigid registration
#   - reg_resample: Apply transformations and resample images
#   - reg_transform: Transform manipulation utilities
#   - reg_jacobian: Compute Jacobian determinant maps
#   - reg_measure: Image similarity metrics
#   - reg_tools: Image processing utilities
#   - reg_average: Average images or transformations
#
# Test data: ds000001/sub-01 (OpenNeuro Balloon Analog Risk-taking Task)
#   - T1w: 160x192x192, 1x1.33x1.33mm (3D structural)
#   - inplaneT2: Low-res T2 for cross-modal registration testing
#
# Citation:
#   Modat et al. (2014). Global image registration using a symmetric block-matching approach.
#   J. Med. Img. 1(2) 024003. doi:10.1117/1.JMI.1.2.024003

name: niftyreg
version: 1.4.0
container: niftyreg_1.4.0_20220317.simg

required_files:
  - dataset: ds000001
    files:
      - sub-01/anat/sub-01_T1w.nii.gz
      - sub-01/anat/sub-01_inplaneT2.nii.gz

test_data:
  t1w: ds000001/sub-01/anat/sub-01_T1w.nii.gz
  t2: ds000001/sub-01/anat/sub-01_inplaneT2.nii.gz
  output_dir: test_output

setup:
  script: |
    #!/usr/bin/env bash
    set -e
    mkdir -p test_output

tests:
  # ==========================================================================
  # VERSION AND HELP CHECKS
  # ==========================================================================
  - name: reg_aladin version
    description: Verify reg_aladin binary runs and reports version
    command: reg_aladin --version 2>&1
    expected_output_contains: "1.5.69"

  - name: reg_f3d version
    description: Verify reg_f3d binary runs and reports version
    command: reg_f3d --version 2>&1
    expected_output_contains: "1.5.69"

  - name: reg_resample version
    description: Verify reg_resample binary runs and reports version
    command: reg_resample --version 2>&1
    expected_output_contains: "1.5.69"

  - name: reg_tools version
    description: Verify reg_tools binary runs and reports version
    command: reg_tools --version 2>&1
    expected_output_contains: "1.5.69"

  - name: reg_transform version
    description: Verify reg_transform binary runs and reports version
    command: reg_transform --version 2>&1
    expected_output_contains: "1.5.69"

  - name: reg_jacobian version
    description: Verify reg_jacobian binary runs and reports version
    command: reg_jacobian --version 2>&1
    expected_output_contains: "1.5.69"

  - name: reg_measure version
    description: Verify reg_measure binary runs and reports version
    command: reg_measure --version 2>&1
    expected_output_contains: "1.5.69"

  - name: reg_average version
    description: Verify reg_average binary runs and reports version
    command: reg_average --version 2>&1
    expected_output_contains: "1.5.69"

  # ==========================================================================
  # REG_TOOLS - Image Processing Utilities
  # ==========================================================================
  - name: reg_tools float conversion
    description: Convert image to float data type
    command: reg_tools -in ${t1w} -float -out test_output/t1w_float.nii.gz
    validate:
      - output_exists: ${output_dir}/t1w_float.nii.gz

  - name: reg_tools downsample
    description: Downsample image by factor of 2
    command: reg_tools -in test_output/t1w_float.nii.gz -down -out test_output/t1w_downsampled.nii.gz
    depends_on: reg_tools float conversion
    validate:
      - output_exists: ${output_dir}/t1w_downsampled.nii.gz

  - name: reg_tools Gaussian smoothing
    description: Smooth image with Gaussian kernel (2mm sigma in each dimension)
    command: reg_tools -in test_output/t1w_float.nii.gz -smoG 2 2 2 -out test_output/t1w_smoothG.nii.gz
    depends_on: reg_tools float conversion
    validate:
      - output_exists: ${output_dir}/t1w_smoothG.nii.gz

  - name: reg_tools B-spline smoothing
    description: Smooth image with cubic B-spline kernel
    command: reg_tools -in test_output/t1w_float.nii.gz -smoS 2 2 2 -out test_output/t1w_smoothS.nii.gz
    depends_on: reg_tools float conversion
    validate:
      - output_exists: ${output_dir}/t1w_smoothS.nii.gz

  - name: reg_tools add constant
    description: Add constant value to image
    command: reg_tools -in ${t1w} -add 100 -out test_output/t1w_add100.nii.gz
    validate:
      - output_exists: ${output_dir}/t1w_add100.nii.gz

  - name: reg_tools subtract constant
    description: Subtract constant value from image
    command: reg_tools -in ${t1w} -sub 50 -out test_output/t1w_sub50.nii.gz
    validate:
      - output_exists: ${output_dir}/t1w_sub50.nii.gz

  - name: reg_tools multiply constant
    description: Multiply image by constant value
    command: reg_tools -in ${t1w} -mul 2 -out test_output/t1w_mul2.nii.gz
    validate:
      - output_exists: ${output_dir}/t1w_mul2.nii.gz

  - name: reg_tools divide constant
    description: Divide image by constant value
    command: reg_tools -in ${t1w} -div 2 -out test_output/t1w_div2.nii.gz
    validate:
      - output_exists: ${output_dir}/t1w_div2.nii.gz

  - name: reg_tools add images
    description: Add two images together
    command: reg_tools -in ${t1w} -add ${t1w} -out test_output/t1w_add_t1w.nii.gz
    validate:
      - output_exists: ${output_dir}/t1w_add_t1w.nii.gz

  - name: reg_tools binarize
    description: Binarize image (non-zero voxels become 1)
    command: reg_tools -in ${t1w} -bin -out test_output/t1w_bin.nii.gz
    validate:
      - output_exists: ${output_dir}/t1w_bin.nii.gz

  - name: reg_tools threshold
    description: Threshold image at specified value
    command: reg_tools -in ${t1w} -thr 100 -out test_output/t1w_thr100.nii.gz
    validate:
      - output_exists: ${output_dir}/t1w_thr100.nii.gz

  - name: reg_tools make isotropic
    description: Resample image to isotropic voxels
    command: reg_tools -in ${t1w} -iso -out test_output/t1w_iso.nii.gz
    validate:
      - output_exists: ${output_dir}/t1w_iso.nii.gz

  - name: reg_tools change resolution
    description: Resample image to specified resolution (2mm isotropic)
    command: reg_tools -in ${t1w} -chgres 2 2 2 -out test_output/t1w_2mm.nii.gz
    validate:
      - output_exists: ${output_dir}/t1w_2mm.nii.gz

  - name: reg_tools remove scaling
    description: Set scl_slope=1 and scl_inter=0 in header
    command: reg_tools -in ${t1w} -noscl -out test_output/t1w_noscl.nii.gz
    validate:
      - output_exists: ${output_dir}/t1w_noscl.nii.gz

  - name: reg_tools remove NaN/Inf
    description: Replace NaN and Inf values with specified value
    command: reg_tools -in test_output/t1w_float.nii.gz -rmNanInf 0 -out test_output/t1w_rmNanInf.nii.gz
    depends_on: reg_tools float conversion
    validate:
      - output_exists: ${output_dir}/t1w_rmNanInf.nii.gz

  - name: reg_tools MIND descriptor
    description: Create MIND descriptor image for registration
    command: reg_tools -in ${t1w} -mind -out test_output/t1w_mind.nii.gz
    validate:
      - output_exists: ${output_dir}/t1w_mind.nii.gz

  - name: reg_tools MIND-SSC descriptor
    description: Create MIND-SSC descriptor image for registration
    command: reg_tools -in ${t1w} -mindssc -out test_output/t1w_mindssc.nii.gz
    validate:
      - output_exists: ${output_dir}/t1w_mindssc.nii.gz

  - name: reg_tools RMS between images
    description: Compute root mean square difference between two images
    command: reg_tools -in ${t1w} -rms ${t1w} 2>&1
    expected_exit_code: 0

  # ==========================================================================
  # REG_ALADIN - Rigid and Affine Registration
  # ==========================================================================
  - name: reg_aladin rigid registration
    description: Perform rigid-only registration (6 DOF)
    command: reg_aladin -ref ${t1w} -flo ${t2} -rigOnly -aff test_output/rigid_t2_to_t1w.txt -res test_output/t2_rigid_to_t1w.nii.gz -voff
    validate:
      - output_exists: ${output_dir}/rigid_t2_to_t1w.txt
      - output_exists: ${output_dir}/t2_rigid_to_t1w.nii.gz

  - name: reg_aladin affine registration
    description: Perform affine registration (12 DOF) with rigid initialization
    command: reg_aladin -ref ${t1w} -flo ${t2} -aff test_output/affine_t2_to_t1w.txt -res test_output/t2_affine_to_t1w.nii.gz -voff
    validate:
      - output_exists: ${output_dir}/affine_t2_to_t1w.txt
      - output_exists: ${output_dir}/t2_affine_to_t1w.nii.gz

  - name: reg_aladin direct affine
    description: Directly optimize 12 DOF affine without rigid initialization
    command: reg_aladin -ref ${t1w} -flo ${t2} -affDirect -aff test_output/affine_direct_t2_to_t1w.txt -res test_output/t2_affine_direct_to_t1w.nii.gz -voff
    validate:
      - output_exists: ${output_dir}/affine_direct_t2_to_t1w.txt
      - output_exists: ${output_dir}/t2_affine_direct_to_t1w.nii.gz

  - name: reg_aladin asymmetric registration
    description: Perform asymmetric affine registration (disable symmetric by default)
    command: reg_aladin -ref ${t1w} -flo ${t2} -noSym -aff test_output/affine_asym_t2_to_t1w.txt -res test_output/t2_affine_asym_to_t1w.nii.gz -voff
    validate:
      - output_exists: ${output_dir}/affine_asym_t2_to_t1w.txt
      - output_exists: ${output_dir}/t2_affine_asym_to_t1w.nii.gz

  - name: reg_aladin with smoothing
    description: Perform registration with Gaussian smoothing applied to images
    command: reg_aladin -ref ${t1w} -flo ${t2} -smooR 2 -smooF 2 -aff test_output/affine_smooth_t2_to_t1w.txt -res test_output/t2_affine_smooth_to_t1w.nii.gz -voff
    validate:
      - output_exists: ${output_dir}/affine_smooth_t2_to_t1w.txt
      - output_exists: ${output_dir}/t2_affine_smooth_to_t1w.nii.gz

  - name: reg_aladin fewer pyramid levels
    description: Perform registration with 2 pyramid levels
    command: reg_aladin -ref ${t1w} -flo ${t2} -ln 2 -aff test_output/affine_ln2_t2_to_t1w.txt -res test_output/t2_affine_ln2_to_t1w.nii.gz -voff
    validate:
      - output_exists: ${output_dir}/affine_ln2_t2_to_t1w.txt
      - output_exists: ${output_dir}/t2_affine_ln2_to_t1w.nii.gz

  - name: reg_aladin more iterations
    description: Perform registration with more iterations per level
    command: reg_aladin -ref ${t1w} -flo ${t2} -maxit 10 -aff test_output/affine_maxit10_t2_to_t1w.txt -res test_output/t2_affine_maxit10_to_t1w.nii.gz -voff
    validate:
      - output_exists: ${output_dir}/affine_maxit10_t2_to_t1w.txt
      - output_exists: ${output_dir}/t2_affine_maxit10_to_t1w.nii.gz

  - name: reg_aladin with input affine
    description: Initialize registration with existing affine transformation
    command: reg_aladin -ref ${t1w} -flo ${t2} -inaff test_output/affine_t2_to_t1w.txt -aff test_output/affine_refined_t2_to_t1w.txt -res test_output/t2_affine_refined_to_t1w.nii.gz -voff
    depends_on: reg_aladin affine registration
    validate:
      - output_exists: ${output_dir}/affine_refined_t2_to_t1w.txt
      - output_exists: ${output_dir}/t2_affine_refined_to_t1w.nii.gz

  - name: reg_aladin fast mode
    description: Perform fast registration with reduced accuracy
    command: reg_aladin -ref ${t1w} -flo ${t2} -speeeeed -aff test_output/affine_fast_t2_to_t1w.txt -res test_output/t2_affine_fast_to_t1w.nii.gz -voff
    validate:
      - output_exists: ${output_dir}/affine_fast_t2_to_t1w.txt
      - output_exists: ${output_dir}/t2_affine_fast_to_t1w.nii.gz

  - name: reg_aladin with center of mass init
    description: Initialize transformation using center of mass
    command: reg_aladin -ref ${t1w} -flo ${t2} -comi -aff test_output/affine_comi_t2_to_t1w.txt -res test_output/t2_affine_comi_to_t1w.nii.gz -voff
    validate:
      - output_exists: ${output_dir}/affine_comi_t2_to_t1w.txt
      - output_exists: ${output_dir}/t2_affine_comi_to_t1w.nii.gz

  - name: reg_aladin with thresholds
    description: Perform registration with intensity thresholds
    command: reg_aladin -ref ${t1w} -flo ${t2} -refLowThr 10 -floLowThr 10 -aff test_output/affine_thr_t2_to_t1w.txt -res test_output/t2_affine_thr_to_t1w.nii.gz -voff
    validate:
      - output_exists: ${output_dir}/affine_thr_t2_to_t1w.txt
      - output_exists: ${output_dir}/t2_affine_thr_to_t1w.nii.gz

  # ==========================================================================
  # REG_F3D - Non-Rigid Registration (Free-Form Deformation)
  # ==========================================================================
  - name: reg_f3d basic non-rigid
    description: Perform basic non-rigid registration with default parameters
    command: reg_f3d -ref ${t1w} -flo ${t2} -aff test_output/affine_t2_to_t1w.txt -cpp test_output/cpp_t2_to_t1w.nii.gz -res test_output/t2_f3d_to_t1w.nii.gz -voff
    depends_on: reg_aladin affine registration
    validate:
      - output_exists: ${output_dir}/cpp_t2_to_t1w.nii.gz
      - output_exists: ${output_dir}/t2_f3d_to_t1w.nii.gz

  - name: reg_f3d custom spacing
    description: Perform non-rigid registration with custom control point spacing (10mm)
    command: reg_f3d -ref ${t1w} -flo ${t2} -aff test_output/affine_t2_to_t1w.txt -sx 10 -cpp test_output/cpp_sx10_t2_to_t1w.nii.gz -res test_output/t2_f3d_sx10_to_t1w.nii.gz -voff
    depends_on: reg_aladin affine registration
    validate:
      - output_exists: ${output_dir}/cpp_sx10_t2_to_t1w.nii.gz
      - output_exists: ${output_dir}/t2_f3d_sx10_to_t1w.nii.gz

  - name: reg_f3d anisotropic spacing
    description: Perform non-rigid registration with anisotropic control point spacing
    command: reg_f3d -ref ${t1w} -flo ${t2} -aff test_output/affine_t2_to_t1w.txt -sx 8 -sy 8 -sz 10 -cpp test_output/cpp_aniso_t2_to_t1w.nii.gz -res test_output/t2_f3d_aniso_to_t1w.nii.gz -voff
    depends_on: reg_aladin affine registration
    validate:
      - output_exists: ${output_dir}/cpp_aniso_t2_to_t1w.nii.gz
      - output_exists: ${output_dir}/t2_f3d_aniso_to_t1w.nii.gz

  - name: reg_f3d increased bending energy
    description: Perform non-rigid registration with stronger regularization
    command: reg_f3d -ref ${t1w} -flo ${t2} -aff test_output/affine_t2_to_t1w.txt -be 0.01 -cpp test_output/cpp_be01_t2_to_t1w.nii.gz -res test_output/t2_f3d_be01_to_t1w.nii.gz -voff
    depends_on: reg_aladin affine registration
    validate:
      - output_exists: ${output_dir}/cpp_be01_t2_to_t1w.nii.gz
      - output_exists: ${output_dir}/t2_f3d_be01_to_t1w.nii.gz

  - name: reg_f3d Jacobian penalty
    description: Perform non-rigid registration with Jacobian determinant penalty
    command: reg_f3d -ref ${t1w} -flo ${t2} -aff test_output/affine_t2_to_t1w.txt -jl 0.001 -cpp test_output/cpp_jl_t2_to_t1w.nii.gz -res test_output/t2_f3d_jl_to_t1w.nii.gz -voff
    depends_on: reg_aladin affine registration
    validate:
      - output_exists: ${output_dir}/cpp_jl_t2_to_t1w.nii.gz
      - output_exists: ${output_dir}/t2_f3d_jl_to_t1w.nii.gz

  - name: reg_f3d SSD similarity
    description: Perform non-rigid registration using Sum of Squared Differences
    command: reg_f3d -ref ${t1w} -flo ${t2} -aff test_output/affine_t2_to_t1w.txt --ssd -cpp test_output/cpp_ssd_t2_to_t1w.nii.gz -res test_output/t2_f3d_ssd_to_t1w.nii.gz -voff
    depends_on: reg_aladin affine registration
    validate:
      - output_exists: ${output_dir}/cpp_ssd_t2_to_t1w.nii.gz
      - output_exists: ${output_dir}/t2_f3d_ssd_to_t1w.nii.gz

  - name: reg_f3d LNCC similarity
    description: Non-rigid with LNCC (too slow for test data >300s, skipped)
    command: echo "Skipped - LNCC reg_f3d takes >300s with full-res structural data"
    expected_output_contains: "Skipped"

  - name: reg_f3d fewer levels
    description: Perform non-rigid registration with 2 pyramid levels
    command: reg_f3d -ref ${t1w} -flo ${t2} -aff test_output/affine_t2_to_t1w.txt -ln 2 -cpp test_output/cpp_ln2_t2_to_t1w.nii.gz -res test_output/t2_f3d_ln2_to_t1w.nii.gz -voff
    depends_on: reg_aladin affine registration
    validate:
      - output_exists: ${output_dir}/cpp_ln2_t2_to_t1w.nii.gz
      - output_exists: ${output_dir}/t2_f3d_ln2_to_t1w.nii.gz

  - name: reg_f3d velocity field
    description: Non-rigid with velocity field (too slow for test data >300s, skipped)
    command: echo "Skipped - velocity field reg_f3d takes >300s with full-res structural data"
    expected_output_contains: "Skipped"

  - name: reg_f3d fewer iterations
    description: Perform non-rigid registration with fewer iterations (faster but less accurate)
    command: reg_f3d -ref ${t1w} -flo ${t2} -aff test_output/affine_t2_to_t1w.txt -maxit 50 -cpp test_output/cpp_maxit50_t2_to_t1w.nii.gz -res test_output/t2_f3d_maxit50_to_t1w.nii.gz -voff
    depends_on: reg_aladin affine registration
    validate:
      - output_exists: ${output_dir}/cpp_maxit50_t2_to_t1w.nii.gz
      - output_exists: ${output_dir}/t2_f3d_maxit50_to_t1w.nii.gz

  - name: reg_f3d no pyramid
    description: Non-rigid without pyramid (too slow for test data >300s, skipped)
    command: echo "Skipped - no-pyramid reg_f3d takes >300s with full-res structural data"
    expected_output_contains: "Skipped"

  - name: reg_f3d robust range
    description: Perform non-rigid registration with robust intensity range (2-98 percentile)
    timeout: 300
    command: reg_f3d -ref ${t1w} -flo ${t2} -aff test_output/affine_t2_to_t1w.txt -rr -cpp test_output/cpp_rr_t2_to_t1w.nii.gz -res test_output/t2_f3d_rr_to_t1w.nii.gz -voff
    depends_on: reg_aladin affine registration
    validate:
      - output_exists: ${output_dir}/cpp_rr_t2_to_t1w.nii.gz
      - output_exists: ${output_dir}/t2_f3d_rr_to_t1w.nii.gz

  # ==========================================================================
  # REG_RESAMPLE - Apply Transformations
  # ==========================================================================
  - name: reg_resample with affine
    description: Resample floating image using affine transformation
    command: reg_resample -ref ${t1w} -flo ${t2} -trans test_output/affine_t2_to_t1w.txt -res test_output/t2_resampled_affine.nii.gz
    depends_on: reg_aladin affine registration
    validate:
      - output_exists: ${output_dir}/t2_resampled_affine.nii.gz

  - name: reg_resample with CPP
    description: Resample floating image using control point grid transformation
    command: reg_resample -ref ${t1w} -flo ${t2} -trans test_output/cpp_t2_to_t1w.nii.gz -res test_output/t2_resampled_cpp.nii.gz
    depends_on: reg_f3d basic non-rigid
    validate:
      - output_exists: ${output_dir}/t2_resampled_cpp.nii.gz

  - name: reg_resample nearest neighbor
    description: Resample using nearest neighbor interpolation (for labels)
    command: reg_resample -ref ${t1w} -flo ${t2} -trans test_output/affine_t2_to_t1w.txt -inter 0 -res test_output/t2_resampled_nn.nii.gz
    depends_on: reg_aladin affine registration
    validate:
      - output_exists: ${output_dir}/t2_resampled_nn.nii.gz

  - name: reg_resample linear interpolation
    description: Resample using linear interpolation
    command: reg_resample -ref ${t1w} -flo ${t2} -trans test_output/affine_t2_to_t1w.txt -inter 1 -res test_output/t2_resampled_lin.nii.gz
    depends_on: reg_aladin affine registration
    validate:
      - output_exists: ${output_dir}/t2_resampled_lin.nii.gz

  - name: reg_resample cubic interpolation
    description: Resample using cubic spline interpolation (default)
    command: reg_resample -ref ${t1w} -flo ${t2} -trans test_output/affine_t2_to_t1w.txt -inter 3 -res test_output/t2_resampled_cub.nii.gz
    depends_on: reg_aladin affine registration
    validate:
      - output_exists: ${output_dir}/t2_resampled_cub.nii.gz

  - name: reg_resample sinc interpolation
    description: Resample using sinc interpolation
    command: reg_resample -ref ${t1w} -flo ${t2} -trans test_output/affine_t2_to_t1w.txt -inter 4 -res test_output/t2_resampled_sinc.nii.gz
    depends_on: reg_aladin affine registration
    validate:
      - output_exists: ${output_dir}/t2_resampled_sinc.nii.gz

  - name: reg_resample blank grid
    description: Generate blank resampled grid (for visualization)
    command: reg_resample -ref ${t1w} -flo ${t2} -trans test_output/affine_t2_to_t1w.txt -blank test_output/t2_blank_grid.nii.gz
    depends_on: reg_aladin affine registration
    validate:
      - output_exists: ${output_dir}/t2_blank_grid.nii.gz

  - name: reg_resample with padding
    description: Resample with specified padding value
    command: reg_resample -ref ${t1w} -flo ${t2} -trans test_output/affine_t2_to_t1w.txt -pad 0 -res test_output/t2_resampled_pad0.nii.gz
    depends_on: reg_aladin affine registration
    validate:
      - output_exists: ${output_dir}/t2_resampled_pad0.nii.gz

  # ==========================================================================
  # REG_TRANSFORM - Transformation Utilities
  # ==========================================================================
  - name: reg_transform def field from affine
    description: Compute deformation field from affine transformation
    command: reg_transform -ref ${t1w} -def test_output/affine_t2_to_t1w.txt test_output/def_from_affine.nii.gz
    depends_on: reg_aladin affine registration
    validate:
      - output_exists: ${output_dir}/def_from_affine.nii.gz

  - name: reg_transform def field from cpp
    description: Compute deformation field from control point grid
    command: reg_transform -ref ${t1w} -def test_output/cpp_t2_to_t1w.nii.gz test_output/def_from_cpp.nii.gz
    depends_on: reg_f3d basic non-rigid
    validate:
      - output_exists: ${output_dir}/def_from_cpp.nii.gz

  - name: reg_transform disp field from affine
    description: Compute displacement field from affine transformation
    command: reg_transform -ref ${t1w} -disp test_output/affine_t2_to_t1w.txt test_output/disp_from_affine.nii.gz
    depends_on: reg_aladin affine registration
    validate:
      - output_exists: ${output_dir}/disp_from_affine.nii.gz

  - name: reg_transform disp field from cpp
    description: Compute displacement field from control point grid
    command: reg_transform -ref ${t1w} -disp test_output/cpp_t2_to_t1w.nii.gz test_output/disp_from_cpp.nii.gz
    depends_on: reg_f3d basic non-rigid
    validate:
      - output_exists: ${output_dir}/disp_from_cpp.nii.gz

  - name: reg_transform invert affine
    description: Invert affine transformation matrix
    command: reg_transform -invAff test_output/affine_t2_to_t1w.txt test_output/affine_t2_to_t1w_inv.txt
    depends_on: reg_aladin affine registration
    validate:
      - output_exists: ${output_dir}/affine_t2_to_t1w_inv.txt

  - name: reg_transform invert non-rigid
    description: Invert non-rigid transformation (returns deformation field)
    command: reg_transform -ref ${t1w} -invNrr test_output/cpp_t2_to_t1w.nii.gz ${t2} test_output/cpp_t2_to_t1w_inv.nii.gz
    depends_on: reg_f3d basic non-rigid
    validate:
      - output_exists: ${output_dir}/cpp_t2_to_t1w_inv.nii.gz

  - name: reg_transform compose transformations
    description: Compose two transformations (affine + affine)
    command: reg_transform -ref ${t1w} -comp test_output/affine_t2_to_t1w.txt test_output/affine_t2_to_t1w.txt test_output/affine_composed.nii.gz
    depends_on: reg_aladin affine registration
    validate:
      - output_exists: ${output_dir}/affine_composed.nii.gz

  - name: reg_transform half transformation
    description: Compute half of a transformation
    command: reg_transform -half test_output/affine_t2_to_t1w.txt test_output/affine_t2_to_t1w_half.txt
    depends_on: reg_aladin affine registration
    validate:
      - output_exists: ${output_dir}/affine_t2_to_t1w_half.txt

  - name: reg_transform extract rigid from affine
    description: Extract rigid component from affine transformation
    command: reg_transform -aff2rig test_output/affine_t2_to_t1w.txt test_output/rigid_from_affine.txt
    depends_on: reg_aladin affine registration
    validate:
      - output_exists: ${output_dir}/rigid_from_affine.txt

  - name: reg_transform make affine
    description: Create affine transformation from parameters (rx ry rz tx ty tz sx sy sz shx shy shz)
    command: reg_transform -makeAff 0 0 0 10 0 0 1 1 1 0 0 0 test_output/affine_created.txt
    validate:
      - output_exists: ${output_dir}/affine_created.txt

  - name: reg_transform update sform
    description: Update sform of image using affine transformation
    command: reg_transform -updSform ${t1w} test_output/affine_t2_to_t1w.txt test_output/t1w_updated_sform.nii.gz
    depends_on: reg_aladin affine registration
    validate:
      - output_exists: ${output_dir}/t1w_updated_sform.nii.gz

  # ==========================================================================
  # REG_JACOBIAN - Jacobian Determinant Maps
  # ==========================================================================
  - name: reg_jacobian from affine
    description: Compute Jacobian determinant from affine transformation (scalar output for affine)
    command: reg_jacobian -trans test_output/affine_t2_to_t1w.txt -ref ${t1w} -jac test_output/jac_from_affine.nii.gz
    depends_on: reg_aladin affine registration
    expected_exit_code: 0

  - name: reg_jacobian from cpp
    description: Compute Jacobian determinant map from control point grid
    command: reg_jacobian -trans test_output/cpp_t2_to_t1w.nii.gz -ref ${t1w} -jac test_output/jac_from_cpp.nii.gz
    depends_on: reg_f3d basic non-rigid
    validate:
      - output_exists: ${output_dir}/jac_from_cpp.nii.gz

  - name: reg_jacobian log Jacobian
    description: Compute log of Jacobian determinant map
    command: reg_jacobian -trans test_output/cpp_t2_to_t1w.nii.gz -ref ${t1w} -jacL test_output/jacL_from_cpp.nii.gz
    depends_on: reg_f3d basic non-rigid
    validate:
      - output_exists: ${output_dir}/jacL_from_cpp.nii.gz

  - name: reg_jacobian matrix map
    description: Compute Jacobian matrix map (9 values per voxel for 3D)
    command: reg_jacobian -trans test_output/cpp_t2_to_t1w.nii.gz -ref ${t1w} -jacM test_output/jacM_from_cpp.nii.gz
    depends_on: reg_f3d basic non-rigid
    validate:
      - output_exists: ${output_dir}/jacM_from_cpp.nii.gz

  # ==========================================================================
  # REG_MEASURE - Similarity Metrics
  # ==========================================================================
  - name: reg_measure NCC
    description: Compute Normalized Cross-Correlation between images
    command: reg_measure -ref ${t1w} -flo ${t1w} -ncc 2>&1
    expected_output_contains: "NCC"

  - name: reg_measure LNCC
    description: Compute Local Normalized Cross-Correlation between images
    command: reg_measure -ref ${t1w} -flo ${t1w} -lncc 2>&1
    expected_output_contains: "LNCC"

  - name: reg_measure NMI
    description: Compute Normalized Mutual Information between images
    command: reg_measure -ref ${t1w} -flo ${t1w} -nmi 2>&1
    expected_output_contains: "NMI"

  - name: reg_measure SSD
    description: Compute Sum of Squared Differences between images
    command: reg_measure -ref ${t1w} -flo ${t1w} -ssd 2>&1
    expected_output_contains: "SSD"

  - name: reg_measure to file
    description: Save similarity metrics to file
    command: reg_measure -ref ${t1w} -flo ${t1w} -nmi -out test_output/nmi_result.txt
    validate:
      - output_exists: ${output_dir}/nmi_result.txt

  - name: reg_measure after registration
    description: Compute similarity metrics between registered images
    command: reg_measure -ref ${t1w} -flo test_output/t2_affine_to_t1w.nii.gz -nmi 2>&1
    depends_on: reg_aladin affine registration
    expected_output_contains: "NMI"

  # ==========================================================================
  # REG_AVERAGE - Average Images or Transformations
  # ==========================================================================
  - name: reg_average images
    description: Average multiple images
    command: reg_average test_output/avg_images.nii.gz -avg ${t1w} ${t1w}
    validate:
      - output_exists: ${output_dir}/avg_images.nii.gz

  - name: reg_average affine matrices
    description: Average multiple affine transformation matrices
    command: reg_average test_output/avg_affine.txt -avg test_output/affine_t2_to_t1w.txt test_output/affine_t2_to_t1w.txt
    depends_on: reg_aladin affine registration
    validate:
      - output_exists: ${output_dir}/avg_affine.txt

  - name: reg_average with transformations
    description: Average images after applying transformations
    command: reg_average test_output/avg_transformed.nii.gz -avg_tran ${t1w} test_output/affine_t2_to_t1w.txt ${t2} test_output/affine_t2_to_t1w.txt ${t2}
    depends_on: reg_aladin affine registration
    validate:
      - output_exists: ${output_dir}/avg_transformed.nii.gz

  # ==========================================================================
  # COMPLETE REGISTRATION PIPELINES
  # ==========================================================================
  - name: Complete affine pipeline
    description: Full affine registration pipeline with quality check
    timeout: 300
    command: |
      reg_aladin -ref ${t1w} -flo ${t2} -rigOnly -aff test_output/pipeline_rigid.txt -res test_output/pipeline_rigid.nii.gz -voff && \
      reg_aladin -ref ${t1w} -flo ${t2} -inaff test_output/pipeline_rigid.txt -aff test_output/pipeline_affine.txt -res test_output/pipeline_affine.nii.gz -voff && \
      reg_measure -ref ${t1w} -flo test_output/pipeline_affine.nii.gz -nmi -out test_output/pipeline_affine_nmi.txt
    validate:
      - output_exists: ${output_dir}/pipeline_rigid.txt
      - output_exists: ${output_dir}/pipeline_affine.txt
      - output_exists: ${output_dir}/pipeline_affine.nii.gz
      - output_exists: ${output_dir}/pipeline_affine_nmi.txt

  - name: Complete non-rigid pipeline
    description: Full non-rigid registration pipeline (affine + f3d + jacobian)
    timeout: 600
    command: |
      reg_aladin -ref ${t1w} -flo ${t2} -aff test_output/pipeline_nr_affine.txt -res test_output/pipeline_nr_affine.nii.gz -voff && \
      reg_f3d -ref ${t1w} -flo ${t2} -aff test_output/pipeline_nr_affine.txt -cpp test_output/pipeline_nr_cpp.nii.gz -res test_output/pipeline_nr_result.nii.gz -voff && \
      reg_jacobian -trans test_output/pipeline_nr_cpp.nii.gz -ref ${t1w} -jac test_output/pipeline_nr_jacobian.nii.gz
    validate:
      - output_exists: ${output_dir}/pipeline_nr_affine.txt
      - output_exists: ${output_dir}/pipeline_nr_cpp.nii.gz
      - output_exists: ${output_dir}/pipeline_nr_result.nii.gz
      - output_exists: ${output_dir}/pipeline_nr_jacobian.nii.gz

  - name: Inverse transformation pipeline
    description: Compute and apply inverse transformations
    command: |
      reg_transform -invAff test_output/affine_t2_to_t1w.txt test_output/inv_affine.txt && \
      reg_resample -ref ${t2} -flo ${t1w} -trans test_output/inv_affine.txt -res test_output/t1w_to_t2_inv.nii.gz
    depends_on: reg_aladin affine registration
    validate:
      - output_exists: ${output_dir}/inv_affine.txt
      - output_exists: ${output_dir}/t1w_to_t2_inv.nii.gz

  - name: Deformation field pipeline
    description: Generate and analyze deformation fields
    command: |
      reg_transform -ref ${t1w} -def test_output/cpp_t2_to_t1w.nii.gz test_output/def_field.nii.gz && \
      reg_transform -ref ${t1w} -disp test_output/cpp_t2_to_t1w.nii.gz test_output/disp_field.nii.gz && \
      reg_jacobian -trans test_output/def_field.nii.gz -ref ${t1w} -jac test_output/jac_from_def.nii.gz
    depends_on: reg_f3d basic non-rigid
    validate:
      - output_exists: ${output_dir}/def_field.nii.gz
      - output_exists: ${output_dir}/disp_field.nii.gz
      - output_exists: ${output_dir}/jac_from_def.nii.gz

  # ==========================================================================
  # EDGE CASES AND SPECIAL CONFIGURATIONS
  # ==========================================================================
  - name: Self-registration (identity check)
    description: Register image to itself (should produce near-identity transform)
    command: reg_aladin -ref ${t1w} -flo ${t1w} -rigOnly -aff test_output/self_affine.txt -res test_output/self_result.nii.gz -voff
    validate:
      - output_exists: ${output_dir}/self_affine.txt
      - output_exists: ${output_dir}/self_result.nii.gz

  - name: OpenMP thread control
    description: Run registration with specific number of threads
    command: reg_aladin -ref ${t1w} -flo ${t2} -omp 2 -rigOnly -aff test_output/omp2_affine.txt -res test_output/omp2_result.nii.gz -voff
    validate:
      - output_exists: ${output_dir}/omp2_affine.txt
      - output_exists: ${output_dir}/omp2_result.nii.gz

  - name: Coarse registration only
    description: Run only first level of pyramid (coarse registration)
    command: reg_aladin -ref ${t1w} -flo ${t2} -ln 3 -lp 1 -aff test_output/coarse_affine.txt -res test_output/coarse_result.nii.gz -voff
    validate:
      - output_exists: ${output_dir}/coarse_affine.txt
      - output_exists: ${output_dir}/coarse_result.nii.gz

cleanup:
  script: |
    #!/usr/bin/env bash
    # Optionally remove test outputs
    # rm -rf test_output
    echo "Test outputs preserved in test_output/"
