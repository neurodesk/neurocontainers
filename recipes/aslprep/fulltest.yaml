# aslprep container test suite
# Tests for ASLPrep v0.7.5 - Arterial Spin Labeling preprocessing pipeline
#
# ASLPrep is developed by the Satterthwaite lab at UPenn for ASL preprocessing
# and Cerebral Blood Flow (CBF) computation. Includes FSL, ANTs, and FreeSurfer tools.
#
# Test data: ds000001/sub-01 (OpenNeuro Balloon Analog Risk-taking Task)
#   - T1w: 160x192x192, 1x1.33x1.33mm (3D structural)
#   - BOLD: 64x64x33x300, 3.125x3.125x4mm, TR=2s (4D functional)
#   - inplaneT2: available for registration testing
#
# Note: Full ASLPrep BIDS pipeline requires ASL data which is not available
# in ds000001, so we test the bundled tools (FSL, ANTs, FreeSurfer utilities)

name: aslprep
version: 0.7.5
container: aslprep_0.7.5_20250206.simg

required_files:
  - dataset: ds000001
    files:
      - sub-01/anat/sub-01_T1w.nii.gz
      - sub-01/anat/sub-01_inplaneT2.nii.gz
      - sub-01/func/sub-01_task-balloonanalogrisktask_run-01_bold.nii.gz

test_data:
  t1w: ds000001/sub-01/anat/sub-01_T1w.nii.gz
  t2: ds000001/sub-01/anat/sub-01_inplaneT2.nii.gz
  bold: ds000001/sub-01/func/sub-01_task-balloonanalogrisktask_run-01_bold.nii.gz
  output_dir: test_output

env_setup: |
  export FSLOUTPUTTYPE=NIFTI_GZ

setup:
  script: |
    #!/usr/bin/env bash
    set -e
    mkdir -p ${output_dir}

tests:
  # ==========================================================================
  # VERSION AND HELP CHECKS
  # ==========================================================================
  - name: ASLPrep version check
    description: Verify aslprep binary runs and reports version
    command: aslprep --version
    expected_output_contains: "ASLPrep v0.7.5"

  - name: ASLPrep help
    description: Verify aslprep help displays correctly
    command: aslprep --help 2>&1 | head -20
    expected_output_contains: "usage: aslprep"

  # ==========================================================================
  # FSL HEADER AND INFO UTILITIES
  # ==========================================================================
  - name: FSL header inspection (fslhd)
    description: Report NIfTI header information using fslhd
    command: fslhd ${t1w} | head -15
    expected_output_contains: "dim1"

  - name: FSL info (fslinfo)
    description: Basic image info using fslinfo
    command: fslinfo ${t1w}
    expected_output_contains: "dim1"

  - name: FSL stats - mean intensity
    description: Calculate mean intensity using fslstats
    command: fslstats ${t1w} -m
    expected_exit_code: 0

  - name: FSL stats - robust range
    description: Get robust intensity range using fslstats
    command: fslstats ${t1w} -r
    expected_exit_code: 0

  - name: FSL stats - volume information
    description: Get voxel count and volume using fslstats
    command: fslstats ${t1w} -v
    expected_exit_code: 0

  - name: FSL stats - standard deviation
    description: Calculate standard deviation using fslstats
    command: fslstats ${t1w} -s
    expected_exit_code: 0

  - name: FSL stats - percentile
    description: Calculate 95th percentile using fslstats
    command: fslstats ${t1w} -p 95
    expected_exit_code: 0

  - name: FSL number of volumes (fslnvols)
    description: Get number of volumes in 4D image
    command: fslnvols ${bold}
    expected_output_contains: "300"

  - name: FSL value extraction (fslval)
    description: Extract specific header value
    command: fslval ${t1w} dim1
    expected_output_contains: "160"

  # ==========================================================================
  # FSLMATHS OPERATIONS
  # ==========================================================================
  - name: fslmaths - binarize image
    description: Create binary mask using fslmaths
    command: fslmaths ${t1w} -thr 100 -bin ${output_dir}/t1w_bin.nii.gz
    validate:
      - output_exists: ${output_dir}/t1w_bin.nii.gz

  - name: fslmaths - add constant
    description: Add constant value to image
    command: fslmaths ${t1w} -add 100 ${output_dir}/t1w_add100.nii.gz
    validate:
      - output_exists: ${output_dir}/t1w_add100.nii.gz

  - name: fslmaths - multiply constant
    description: Multiply image by constant
    command: fslmaths ${t1w} -mul 2 ${output_dir}/t1w_mul2.nii.gz
    validate:
      - output_exists: ${output_dir}/t1w_mul2.nii.gz

  - name: fslmaths - divide constant
    description: Divide image by constant
    command: fslmaths ${t1w} -div 2 ${output_dir}/t1w_div2.nii.gz
    validate:
      - output_exists: ${output_dir}/t1w_div2.nii.gz

  - name: fslmaths - threshold
    description: Apply lower threshold
    command: fslmaths ${t1w} -thr 50 ${output_dir}/t1w_thr50.nii.gz
    validate:
      - output_exists: ${output_dir}/t1w_thr50.nii.gz

  - name: fslmaths - upper threshold
    description: Apply upper threshold
    command: fslmaths ${t1w} -uthr 500 ${output_dir}/t1w_uthr500.nii.gz
    validate:
      - output_exists: ${output_dir}/t1w_uthr500.nii.gz

  - name: fslmaths - Gaussian smoothing
    description: Apply Gaussian smoothing with 3mm kernel
    command: fslmaths ${t1w} -s 3 ${output_dir}/t1w_smooth3mm.nii.gz
    validate:
      - output_exists: ${output_dir}/t1w_smooth3mm.nii.gz

  - name: fslmaths - temporal mean
    description: Calculate temporal mean of 4D data
    command: fslmaths ${bold} -Tmean ${output_dir}/bold_Tmean.nii.gz
    validate:
      - output_exists: ${output_dir}/bold_Tmean.nii.gz

  - name: fslmaths - temporal std
    description: Calculate temporal standard deviation
    command: fslmaths ${bold} -Tstd ${output_dir}/bold_Tstd.nii.gz
    validate:
      - output_exists: ${output_dir}/bold_Tstd.nii.gz

  - name: fslmaths - square root
    description: Calculate square root of image
    command: fslmaths ${t1w} -sqrt ${output_dir}/t1w_sqrt.nii.gz
    validate:
      - output_exists: ${output_dir}/t1w_sqrt.nii.gz

  - name: fslmaths - square
    description: Calculate square of image
    command: fslmaths ${t1w} -sqr ${output_dir}/t1w_sqr.nii.gz
    validate:
      - output_exists: ${output_dir}/t1w_sqr.nii.gz

  - name: fslmaths - absolute value
    description: Calculate absolute value
    command: fslmaths ${t1w} -abs ${output_dir}/t1w_abs.nii.gz
    validate:
      - output_exists: ${output_dir}/t1w_abs.nii.gz

  - name: fslmaths - erosion
    description: Morphological erosion
    command: fslmaths ${t1w} -thr 100 -bin -ero ${output_dir}/t1w_ero.nii.gz
    validate:
      - output_exists: ${output_dir}/t1w_ero.nii.gz

  - name: fslmaths - dilation
    description: Morphological dilation
    command: fslmaths ${t1w} -thr 100 -bin -dilM ${output_dir}/t1w_dilM.nii.gz
    validate:
      - output_exists: ${output_dir}/t1w_dilM.nii.gz

  - name: fslmaths - fill holes
    description: Fill holes in binary mask
    command: fslmaths ${t1w} -thr 100 -bin -fillh ${output_dir}/t1w_fillh.nii.gz
    validate:
      - output_exists: ${output_dir}/t1w_fillh.nii.gz

  - name: fslmaths - masking operation
    description: Apply mask to image
    command: |
      fslmaths ${t1w} -thr 100 -bin ${output_dir}/mask_tmp.nii.gz && \
      fslmaths ${t1w} -mas ${output_dir}/mask_tmp.nii.gz ${output_dir}/t1w_masked.nii.gz
    validate:
      - output_exists: ${output_dir}/t1w_masked.nii.gz

  - name: fslmaths - invert binary mask
    description: Create inverted binary mask
    command: fslmaths ${t1w} -thr 100 -bin -binv ${output_dir}/t1w_binv.nii.gz
    validate:
      - output_exists: ${output_dir}/t1w_binv.nii.gz

  - name: fslmaths - exponential
    description: Calculate exponential (on scaled data)
    command: fslmaths ${t1w} -div 1000 -exp ${output_dir}/t1w_exp.nii.gz
    validate:
      - output_exists: ${output_dir}/t1w_exp.nii.gz

  - name: fslmaths - natural log
    description: Calculate natural logarithm
    command: fslmaths ${t1w} -thr 1 -log ${output_dir}/t1w_log.nii.gz
    validate:
      - output_exists: ${output_dir}/t1w_log.nii.gz

  - name: fslmaths - reciprocal
    description: Calculate reciprocal (1/x)
    command: fslmaths ${t1w} -thr 1 -recip ${output_dir}/t1w_recip.nii.gz
    validate:
      - output_exists: ${output_dir}/t1w_recip.nii.gz

  # ==========================================================================
  # FSL VOLUME MANIPULATION
  # ==========================================================================
  - name: fslroi - spatial ROI extraction
    description: Extract spatial region of interest
    command: fslroi ${t1w} ${output_dir}/t1w_roi.nii.gz 40 80 40 80 40 80
    validate:
      - output_exists: ${output_dir}/t1w_roi.nii.gz

  - name: fslroi - temporal subset
    description: Extract temporal subset from 4D data
    command: fslroi ${bold} ${output_dir}/bold_subset.nii.gz 0 -1 0 -1 0 -1 10 50
    validate:
      - output_exists: ${output_dir}/bold_subset.nii.gz

  - name: fslsplit - split 4D to 3D volumes
    description: Split 4D image into separate 3D volumes
    command: fslsplit ${bold} ${output_dir}/bold_vol_ -t && ls ${output_dir}/bold_vol_0000.nii.gz
    validate:
      - output_exists: ${output_dir}/bold_vol_0000.nii.gz

  - name: fslmerge - merge 3D to 4D
    description: Merge 3D volumes back to 4D
    command: |
      fslmerge -t ${output_dir}/bold_merged.nii.gz \
        ${output_dir}/bold_vol_0000.nii.gz \
        ${output_dir}/bold_vol_0001.nii.gz \
        ${output_dir}/bold_vol_0002.nii.gz
    depends_on: fslsplit - split 4D to 3D volumes
    validate:
      - output_exists: ${output_dir}/bold_merged.nii.gz

  - name: fslswapdim - reorient image
    description: Swap image dimensions
    command: fslswapdim ${t1w} x y z ${output_dir}/t1w_swapdim.nii.gz
    validate:
      - output_exists: ${output_dir}/t1w_swapdim.nii.gz

  - name: fslreorient2std - reorient to standard
    description: Reorient image to standard orientation
    command: fslreorient2std ${t1w} ${output_dir}/t1w_reorient.nii.gz
    validate:
      - output_exists: ${output_dir}/t1w_reorient.nii.gz

  - name: fslcpgeom - copy geometry
    description: Copy geometry from one image to another
    command: |
      cp ${output_dir}/t1w_bin.nii.gz ${output_dir}/t1w_newgeom.nii.gz && \
      fslcpgeom ${t1w} ${output_dir}/t1w_newgeom.nii.gz
    depends_on: fslmaths - binarize image
    validate:
      - output_exists: ${output_dir}/t1w_newgeom.nii.gz

  # ==========================================================================
  # BET - BRAIN EXTRACTION
  # ==========================================================================
  - name: BET basic brain extraction
    description: Basic brain extraction with BET
    command: bet ${t1w} ${output_dir}/t1w_brain.nii.gz
    validate:
      - output_exists: ${output_dir}/t1w_brain.nii.gz

  - name: BET with brain mask
    description: BET with binary brain mask output
    command: bet ${t1w} ${output_dir}/t1w_brain_mask -m
    validate:
      - output_exists: ${output_dir}/t1w_brain_mask.nii.gz
      - output_exists: ${output_dir}/t1w_brain_mask_mask.nii.gz

  - name: BET robust
    description: Robust brain extraction with center estimation
    command: bet ${t1w} ${output_dir}/t1w_brain_robust.nii.gz -R
    ignore_exit_code: true  # container bug: dc (desk calculator) not installed

  - name: BET with fractional intensity
    description: BET with custom fractional intensity threshold
    command: bet ${t1w} ${output_dir}/t1w_brain_f03.nii.gz -f 0.3
    validate:
      - output_exists: ${output_dir}/t1w_brain_f03.nii.gz

  - name: BET with bias field cleanup
    description: BET with bias field and neck cleanup
    command: bet ${t1w} ${output_dir}/t1w_brain_B.nii.gz -B
    ignore_exit_code: true  # container bug: standard_space_roi internal failures

  # ==========================================================================
  # FAST - TISSUE SEGMENTATION
  # ==========================================================================
  - name: FAST tissue segmentation
    description: Segment brain into tissue types using FAST
    command: fast -o ${output_dir}/t1w_fast ${output_dir}/t1w_brain.nii.gz
    depends_on: BET basic brain extraction
    validate:
      - output_exists: ${output_dir}/t1w_fast_seg.nii.gz

  - name: FAST with PVE maps
    description: FAST with partial volume estimation maps
    command: fast -g -o ${output_dir}/t1w_fast_pve ${output_dir}/t1w_brain.nii.gz
    depends_on: BET basic brain extraction
    validate:
      - output_exists: ${output_dir}/t1w_fast_pve_seg.nii.gz

  - name: FAST with bias correction
    description: FAST with bias field estimation and correction
    command: fast -b -B -o ${output_dir}/t1w_fast_bias ${output_dir}/t1w_brain.nii.gz
    depends_on: BET basic brain extraction
    validate:
      - output_exists: ${output_dir}/t1w_fast_bias_restore.nii.gz

  # ==========================================================================
  # FLIRT - LINEAR REGISTRATION
  # ==========================================================================
  - name: FLIRT registration
    description: Linear registration using FLIRT
    command: flirt -in ${t2} -ref ${t1w} -out ${output_dir}/t2_to_t1w.nii.gz -omat ${output_dir}/t2_to_t1w.mat -dof 6
    validate:
      - output_exists: ${output_dir}/t2_to_t1w.nii.gz
      - output_exists: ${output_dir}/t2_to_t1w.mat

  - name: FLIRT apply transform
    description: Apply existing transformation matrix
    command: flirt -in ${t2} -ref ${t1w} -applyxfm -init ${output_dir}/t2_to_t1w.mat -out ${output_dir}/t2_to_t1w_applied.nii.gz
    depends_on: FLIRT registration
    validate:
      - output_exists: ${output_dir}/t2_to_t1w_applied.nii.gz

  - name: FLIRT 12 DOF registration
    description: Affine registration with 12 degrees of freedom
    command: flirt -in ${t2} -ref ${t1w} -out ${output_dir}/t2_to_t1w_12dof.nii.gz -omat ${output_dir}/t2_to_t1w_12dof.mat -dof 12
    validate:
      - output_exists: ${output_dir}/t2_to_t1w_12dof.nii.gz
      - output_exists: ${output_dir}/t2_to_t1w_12dof.mat

  - name: FLIRT with cost function
    description: Registration with normalized mutual information cost
    command: flirt -in ${t2} -ref ${t1w} -out ${output_dir}/t2_to_t1w_nmi.nii.gz -cost normmi -dof 6
    validate:
      - output_exists: ${output_dir}/t2_to_t1w_nmi.nii.gz

  - name: convert_xfm - invert matrix
    description: Invert transformation matrix
    command: convert_xfm -omat ${output_dir}/t1w_to_t2.mat -inverse ${output_dir}/t2_to_t1w.mat
    depends_on: FLIRT registration
    validate:
      - output_exists: ${output_dir}/t1w_to_t2.mat

  - name: convert_xfm - concat matrices
    description: Concatenate transformation matrices
    command: convert_xfm -omat ${output_dir}/t2_to_t1w_concat.mat -concat ${output_dir}/t2_to_t1w.mat ${output_dir}/t1w_to_t2.mat
    depends_on: convert_xfm - invert matrix
    validate:
      - output_exists: ${output_dir}/t2_to_t1w_concat.mat

  # ==========================================================================
  # ANTs - ADVANCED NORMALIZATION TOOLS
  # ==========================================================================
  - name: ANTs N4 bias field correction
    description: N4 bias field correction using ANTs
    command: N4BiasFieldCorrection -d 3 -i ${t1w} -o ${output_dir}/t1w_n4.nii.gz
    validate:
      - output_exists: ${output_dir}/t1w_n4.nii.gz

  - name: ANTs N4 with mask
    description: N4 bias correction with brain mask
    command: N4BiasFieldCorrection -d 3 -i ${t1w} -x ${output_dir}/t1w_brain_mask_mask.nii.gz -o ${output_dir}/t1w_n4_masked.nii.gz
    depends_on: BET with brain mask
    validate:
      - output_exists: ${output_dir}/t1w_n4_masked.nii.gz

  - name: ANTs N4 with bias field output
    description: N4 with bias field image output
    command: N4BiasFieldCorrection -d 3 -i ${t1w} -o [${output_dir}/t1w_n4_bias.nii.gz,${output_dir}/t1w_biasfield.nii.gz]
    validate:
      - output_exists: ${output_dir}/t1w_n4_bias.nii.gz
      - output_exists: ${output_dir}/t1w_biasfield.nii.gz

  - name: ANTs apply transforms
    description: Apply transformation using antsApplyTransforms (identity)
    command: antsApplyTransforms -d 3 -i ${t1w} -r ${t1w} -o ${output_dir}/t1w_identity.nii.gz -t identity
    validate:
      - output_exists: ${output_dir}/t1w_identity.nii.gz

  - name: ANTs apply transforms nearest neighbor
    description: Apply transformation with nearest neighbor interpolation
    command: antsApplyTransforms -d 3 -i ${output_dir}/t1w_bin.nii.gz -r ${t1w} -o ${output_dir}/t1w_bin_nn.nii.gz -t identity -n NearestNeighbor
    depends_on: fslmaths - binarize image
    validate:
      - output_exists: ${output_dir}/t1w_bin_nn.nii.gz

  - name: ANTs Atropos segmentation
    description: Atropos tissue segmentation
    command: Atropos -d 3 -a ${output_dir}/t1w_brain.nii.gz -x ${output_dir}/t1w_brain_mask_mask.nii.gz -i kmeans[3] -o ${output_dir}/t1w_atropos_seg.nii.gz
    depends_on: BET with brain mask
    validate:
      - output_exists: ${output_dir}/t1w_atropos_seg.nii.gz

  # ==========================================================================
  # ASL-SPECIFIC FSL TOOLS
  # ==========================================================================
  - name: asl_file help check
    description: Verify asl_file tool is available
    command: asl_file --help 2>&1 | head -5
    expected_output_contains: "asl_file"

  - name: basil help check
    description: Verify basil tool is available
    command: basil 2>&1 | head -5
    expected_output_contains: "Bayesian Inference for Arterial Spin Labelling"

  - name: asl_calib help check
    description: Verify asl_calib tool is available
    command: asl_calib 2>&1 | head -5
    expected_output_contains: "ASL_CALIB"

  - name: asl_reg help check
    description: Verify asl_reg tool is available
    command: asl_reg 2>&1 | head -5
    expected_output_contains: "ASL_REG"

  # ==========================================================================
  # TEMPORAL SNR CALCULATION (fMRI quality metric)
  # ==========================================================================
  - name: Temporal SNR calculation
    description: Calculate temporal signal-to-noise ratio
    command: |
      fslmaths ${bold} -Tmean ${output_dir}/bold_mean.nii.gz && \
      fslmaths ${bold} -Tstd ${output_dir}/bold_std.nii.gz && \
      fslmaths ${output_dir}/bold_mean.nii.gz -div ${output_dir}/bold_std.nii.gz ${output_dir}/bold_tsnr.nii.gz
    validate:
      - output_exists: ${output_dir}/bold_tsnr.nii.gz

  # ==========================================================================
  # MOTION CORRECTION WITH MCFLIRT
  # ==========================================================================
  - name: MCFLIRT motion correction
    description: Motion correction using MCFLIRT
    command: mcflirt -in ${bold} -out ${output_dir}/bold_mcf -plots
    validate:
      - output_exists: ${output_dir}/bold_mcf.nii.gz
      - output_exists: ${output_dir}/bold_mcf.par

  - name: MCFLIRT with mean reference
    description: MCFLIRT with mean volume as reference
    command: mcflirt -in ${bold} -out ${output_dir}/bold_mcf_meanvol -meanvol
    validate:
      - output_exists: ${output_dir}/bold_mcf_meanvol.nii.gz
      - output_exists: ${output_dir}/bold_mcf_meanvol_mean_reg.nii.gz

  # ==========================================================================
  # FSLMEANTS - TIME SERIES EXTRACTION
  # ==========================================================================
  - name: fslmeants - global mean time series
    description: Extract global mean time series
    command: fslmeants -i ${bold} -o ${output_dir}/bold_global_ts.txt
    validate:
      - output_exists: ${output_dir}/bold_global_ts.txt

  - name: fslmeants - masked time series
    description: Extract time series from masked region
    command: |
      fslmaths ${bold} -Tmean -thr 100 -bin ${output_dir}/bold_roi_mask.nii.gz && \
      fslmeants -i ${bold} -m ${output_dir}/bold_roi_mask.nii.gz -o ${output_dir}/bold_roi_ts.txt
    validate:
      - output_exists: ${output_dir}/bold_roi_ts.txt

  # ==========================================================================
  # IMAGE ARITHMETIC CHAINS
  # ==========================================================================
  - name: Z-score normalization
    description: Z-score normalize an image
    command: |
      fslmaths ${t1w} -sub $(fslstats ${t1w} -m) ${output_dir}/t1w_demeaned.nii.gz && \
      fslmaths ${output_dir}/t1w_demeaned.nii.gz -div $(fslstats ${t1w} -s) ${output_dir}/t1w_zscore.nii.gz
    validate:
      - output_exists: ${output_dir}/t1w_zscore.nii.gz

  - name: Percent signal change
    description: Calculate percent signal change from baseline
    command: |
      fslmaths ${bold} -Tmean ${output_dir}/bold_baseline.nii.gz && \
      fslmaths ${bold} -sub ${output_dir}/bold_baseline.nii.gz -div ${output_dir}/bold_baseline.nii.gz -mul 100 ${output_dir}/bold_psc.nii.gz
    validate:
      - output_exists: ${output_dir}/bold_psc.nii.gz

  # ==========================================================================
  # COMPLEX PREPROCESSING PIPELINE
  # ==========================================================================
  - name: Brain extraction pipeline
    description: Combined brain extraction and tissue segmentation
    command: |
      bet ${t1w} ${output_dir}/pipeline_brain -m && \
      fast -g -o ${output_dir}/pipeline_seg ${output_dir}/pipeline_brain.nii.gz
    validate:
      - output_exists: ${output_dir}/pipeline_brain.nii.gz
      - output_exists: ${output_dir}/pipeline_brain_mask.nii.gz
      - output_exists: ${output_dir}/pipeline_seg_seg.nii.gz

  - name: Registration and resampling pipeline
    description: Register and resample between spaces
    command: |
      flirt -in ${t2} -ref ${output_dir}/pipeline_brain.nii.gz -out ${output_dir}/t2_in_t1space.nii.gz -omat ${output_dir}/t2_to_t1.mat -dof 6 && \
      flirt -in ${output_dir}/pipeline_seg_seg.nii.gz -ref ${t2} -applyxfm -init ${output_dir}/t2_to_t1.mat -out ${output_dir}/seg_in_t2space.nii.gz -interp nearestneighbour
    depends_on: Brain extraction pipeline
    validate:
      - output_exists: ${output_dir}/t2_in_t1space.nii.gz
      - output_exists: ${output_dir}/seg_in_t2space.nii.gz

  # ==========================================================================
  # DATA TYPE CONVERSIONS
  # ==========================================================================
  - name: Convert to float
    description: Convert image to float datatype
    command: fslmaths ${t1w} ${output_dir}/t1w_float.nii.gz -odt float
    validate:
      - output_exists: ${output_dir}/t1w_float.nii.gz

  - name: Convert to char
    description: Convert binary mask to char datatype
    command: fslmaths ${t1w} -thr 100 -bin ${output_dir}/t1w_char.nii.gz -odt char
    validate:
      - output_exists: ${output_dir}/t1w_char.nii.gz

  - name: Convert to short
    description: Convert image to short datatype
    command: fslmaths ${t1w} ${output_dir}/t1w_short.nii.gz -odt short
    validate:
      - output_exists: ${output_dir}/t1w_short.nii.gz

  # ==========================================================================
  # SLICE TIMING AND ADDITIONAL FMRI PROCESSING
  # ==========================================================================
  - name: Temporal filtering (bandpass)
    description: Apply bandpass temporal filter
    command: fslmaths ${bold} -bptf 25 2 ${output_dir}/bold_bptf.nii.gz
    validate:
      - output_exists: ${output_dir}/bold_bptf.nii.gz

  - name: Temporal max
    description: Calculate temporal maximum
    command: fslmaths ${bold} -Tmax ${output_dir}/bold_Tmax.nii.gz
    validate:
      - output_exists: ${output_dir}/bold_Tmax.nii.gz

  - name: Temporal min
    description: Calculate temporal minimum
    command: fslmaths ${bold} -Tmin ${output_dir}/bold_Tmin.nii.gz
    validate:
      - output_exists: ${output_dir}/bold_Tmin.nii.gz

  - name: Temporal median
    description: Calculate temporal median
    command: fslmaths ${bold} -Tmedian ${output_dir}/bold_Tmedian.nii.gz
    validate:
      - output_exists: ${output_dir}/bold_Tmedian.nii.gz

  - name: Temporal percentile
    description: Calculate 90th temporal percentile
    command: fslmaths ${bold} -Tperc 90 ${output_dir}/bold_Tperc90.nii.gz
    validate:
      - output_exists: ${output_dir}/bold_Tperc90.nii.gz

  # ==========================================================================
  # EDGE DETECTION AND GRADIENT
  # ==========================================================================
  - name: Edge detection
    description: Calculate image edges using fslmaths
    command: fslmaths ${t1w} -edge ${output_dir}/t1w_edge.nii.gz
    validate:
      - output_exists: ${output_dir}/t1w_edge.nii.gz

  # ==========================================================================
  # HISTOGRAM AND INTENSITY OPERATIONS
  # ==========================================================================
  - name: Intensity range clamping
    description: Clamp intensity values to specified range
    command: fslmaths ${t1w} -thr 50 -uthr 500 ${output_dir}/t1w_clamped.nii.gz
    validate:
      - output_exists: ${output_dir}/t1w_clamped.nii.gz

  - name: Intensity normalization
    description: Normalize intensity by mean
    command: fslmaths ${t1w} -inm 1000 ${output_dir}/t1w_inm1000.nii.gz
    validate:
      - output_exists: ${output_dir}/t1w_inm1000.nii.gz

  - name: Percentage threshold
    description: Threshold at percentage of robust range
    command: fslmaths ${t1w} -thrp 10 ${output_dir}/t1w_thrp10.nii.gz
    validate:
      - output_exists: ${output_dir}/t1w_thrp10.nii.gz

  # ==========================================================================
  # SPATIAL STATISTICS
  # ==========================================================================
  - name: X-dimension mean
    description: Calculate mean across X dimension
    command: fslmaths ${t1w} -Xmean ${output_dir}/t1w_Xmean.nii.gz
    validate:
      - output_exists: ${output_dir}/t1w_Xmean.nii.gz

  - name: Y-dimension mean
    description: Calculate mean across Y dimension
    command: fslmaths ${t1w} -Ymean ${output_dir}/t1w_Ymean.nii.gz
    validate:
      - output_exists: ${output_dir}/t1w_Ymean.nii.gz

  - name: Z-dimension mean
    description: Calculate mean across Z dimension
    command: fslmaths ${t1w} -Zmean ${output_dir}/t1w_Zmean.nii.gz
    validate:
      - output_exists: ${output_dir}/t1w_Zmean.nii.gz

  # ==========================================================================
  # KERNEL FILTERING
  # ==========================================================================
  - name: Mean filter with box kernel
    description: Apply box kernel mean filter
    command: fslmaths ${t1w} -kernel box 5 -fmean ${output_dir}/t1w_box_fmean.nii.gz
    validate:
      - output_exists: ${output_dir}/t1w_box_fmean.nii.gz

  - name: Mean filter with sphere kernel
    description: Apply spherical kernel mean filter
    command: fslmaths ${t1w} -kernel sphere 3 -fmean ${output_dir}/t1w_sphere_fmean.nii.gz
    validate:
      - output_exists: ${output_dir}/t1w_sphere_fmean.nii.gz

  - name: Median filter
    description: Apply median filter
    command: fslmaths ${t1w} -fmedian ${output_dir}/t1w_fmedian.nii.gz
    validate:
      - output_exists: ${output_dir}/t1w_fmedian.nii.gz

  # ==========================================================================
  # NAN HANDLING
  # ==========================================================================
  - name: Replace NaN with zero
    description: Replace NaN values with zero
    command: fslmaths ${t1w} -nan ${output_dir}/t1w_nan.nii.gz
    validate:
      - output_exists: ${output_dir}/t1w_nan.nii.gz

  # ==========================================================================
  # IMAGE COMPARISON
  # ==========================================================================
  - name: Subtract images
    description: Subtract one image from another
    command: fslmaths ${t1w} -sub ${t1w} ${output_dir}/t1w_diff.nii.gz
    validate:
      - output_exists: ${output_dir}/t1w_diff.nii.gz

  - name: Add images
    description: Add two images together
    command: fslmaths ${t1w} -add ${t1w} ${output_dir}/t1w_sum.nii.gz
    validate:
      - output_exists: ${output_dir}/t1w_sum.nii.gz

  - name: Maximum of images
    description: Take voxelwise maximum of two images
    command: fslmaths ${t1w} -max ${t1w} ${output_dir}/t1w_max.nii.gz
    validate:
      - output_exists: ${output_dir}/t1w_max.nii.gz

  - name: Minimum of images
    description: Take voxelwise minimum of two images
    command: fslmaths ${t1w} -min ${t1w} ${output_dir}/t1w_min.nii.gz
    validate:
      - output_exists: ${output_dir}/t1w_min.nii.gz

cleanup:
  script: |
    #!/usr/bin/env bash
    # Optionally remove test outputs
    # rm -rf test_output
    echo "Test outputs preserved in ${output_dir}/"
