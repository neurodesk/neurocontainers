# bidsappspm container test suite
# Tests for bidsappspm 0.0.20 - BIDS App containing SPM12 for fMRI processing
#
# Container: SPM12 (r7771) compiled with MATLAB R2019b MCR
# Purpose: BIDS-compliant structural and functional MRI preprocessing
#
# Test data: ds000001 (OpenNeuro Balloon Analog Risk-taking Task)
#   - T1w: sub-02/anat/sub-02_T1w.nii.gz (structural)
#   - T2:  sub-02/anat/sub-02_inplaneT2.nii.gz (inplane T2)
#   - BOLD: sub-02/func/sub-02_task-balloonanalogrisktask_run-01_bold.nii.gz (4D fMRI)
#
# Note: sub-01 lacks T1w image, so sub-02 is used for full pipeline tests
# Note: Full preprocessing pipeline is computationally intensive (15-30 min)

name: bidsappspm
version: 0.0.20
container: bidsappspm_0.0.20_20230629.simg

required_files:
  - dataset: ds000001
    files:
      - dataset_description.json
      - participants.tsv
      - sub-02/anat/sub-02_T1w.nii.gz
      - sub-02/anat/sub-02_inplaneT2.nii.gz
      - sub-02/func/sub-02_task-balloonanalogrisktask_run-01_bold.nii.gz
      - sub-03/anat/sub-03_T1w.nii.gz
      - sub-03/func/sub-03_task-balloonanalogrisktask_run-01_bold.nii.gz

test_data:
  bids_dir: ds000001
  t1w: ds000001/sub-02/anat/sub-02_T1w.nii.gz
  t2: ds000001/sub-02/anat/sub-02_inplaneT2.nii.gz
  bold: ds000001/sub-02/func/sub-02_task-balloonanalogrisktask_run-01_bold.nii.gz
  output_dir: test_output

setup:
  script: |
    #!/usr/bin/env bash
    set -e
    mkdir -p ${output_dir}/bidsappspm
    mkdir -p ${output_dir}/bidsappspm_participant
    mkdir -p ${output_dir}/bidsappspm_group

tests:
  # ==========================================================================
  # BASIC FUNCTIONALITY AND VERSION CHECKS
  # ==========================================================================
  - name: Version check
    description: Verify SPM BIDS App reports version information
    command: /opt/spm12/run.sh --version 2>&1
    expected_output_contains: "SPM12"

  - name: Version check - MATLAB runtime
    description: Verify MATLAB runtime version is reported
    command: /opt/spm12/run.sh --version 2>&1
    expected_output_contains: "MATLAB"

  - name: Version check - SPM revision
    description: Verify SPM revision number
    command: /opt/spm12/run.sh --version 2>&1
    expected_output_contains: "7771"

  - name: Help output
    description: Verify help documentation is displayed
    command: /opt/spm12/run.sh --help 2>&1
    expected_output_contains: "Usage: bids/spm BIDS_DIR OUTPUT_DIR LEVEL"

  - name: Help shows participant option
    description: Verify participant_label option is documented
    command: /opt/spm12/run.sh --help 2>&1
    expected_output_contains: "--participant_label"

  - name: Help shows config option
    description: Verify config file option is documented
    command: /opt/spm12/run.sh --help 2>&1
    expected_output_contains: "--config"

  - name: Help shows skip-bids-validator option
    description: Verify skip-bids-validator option is documented
    command: /opt/spm12/run.sh --help 2>&1
    expected_output_contains: "--skip-bids-validator"

  - name: Help shows analysis levels
    description: Verify participant and group levels are documented
    command: /opt/spm12/run.sh --help 2>&1
    expected_output_contains: "{participant,group}"

  # ==========================================================================
  # ENVIRONMENT VERIFICATION
  # ==========================================================================
  - name: SPM executable exists
    description: Verify SPM12 compiled executable is present
    command: ls -la /opt/spm12/spm12
    expected_output_contains: "spm12"

  - name: SPM CTF archive exists
    description: Verify SPM12 component technology file archive is present
    command: ls -la /opt/spm12/spm12.ctf
    expected_output_contains: "spm12.ctf"

  - name: Run script exists
    description: Verify main run.sh script is present and executable
    command: ls -la /opt/spm12/run.sh
    expected_output_contains: "rwx"

  - name: MCR directory exists
    description: Verify MATLAB Compiler Runtime is installed
    command: ls -d /opt/mcr/v97
    expected_output_contains: "/opt/mcr/v97"

  - name: SPM_DIR environment variable
    description: Verify SPM_DIR is set correctly
    command: echo $SPM_DIR
    expected_output_contains: "/opt/spm12"

  - name: SPM_EXEC environment variable
    description: Verify SPM_EXEC points to compiled binary
    command: echo $SPM_EXEC
    expected_output_contains: "/opt/spm12/spm12"

  - name: MCR_VERSION environment variable
    description: Verify MCR version is set
    command: echo $MCR_VERSION
    expected_output_contains: "v97"

  - name: PATH includes SPM directory
    description: Verify SPM is in PATH
    command: echo $PATH
    expected_output_contains: "/opt/spm12"

  # ==========================================================================
  # PIPELINE CONFIGURATION FILES
  # ==========================================================================
  - name: Participant pipeline exists
    description: Verify default participant-level pipeline configuration
    command: ls -la /opt/spm12/pipeline_participant.m
    expected_output_contains: "pipeline_participant.m"

  - name: Group pipeline exists
    description: Verify default group-level pipeline configuration
    command: ls -la /opt/spm12/pipeline_group.m
    expected_output_contains: "pipeline_group.m"

  - name: BIDS App main script exists
    description: Verify spm_BIDS_App.m is present
    command: ls -la /opt/spm12/spm_BIDS_App.m
    expected_output_contains: "spm_BIDS_App.m"

  # ==========================================================================
  # INPUT VALIDATION TESTS
  # ==========================================================================
  - name: Error on missing BIDS directory
    description: Verify error when BIDS directory does not exist
    command: /opt/spm12/run.sh /nonexistent/path ${output_dir}/bidsappspm participant 2>&1 || true
    expected_output_contains: "does not exist"

  - name: Error on missing output directory for group level
    description: Verify error when output directory missing for group analysis
    command: /opt/spm12/run.sh ${bids_dir} /nonexistent/output group 2>&1 || true
    expected_output_contains: "does not exist"

  - name: Error on invalid analysis level
    description: Verify error on unknown analysis level
    command: /opt/spm12/run.sh ${bids_dir} ${output_dir}/bidsappspm invalid_level 2>&1 || true
    expected_output_contains: "Unknown analysis level"

  - name: Error on missing participant
    description: Verify error when specified participant does not exist
    command: /opt/spm12/run.sh ${bids_dir} ${output_dir}/bidsappspm participant --participant_label 99 --skip-bids-validator 2>&1 || true
    expected_output_contains: "does not exist"

  # ==========================================================================
  # BIDS STRUCTURE VALIDATION
  # ==========================================================================
  - name: BIDS directory readable
    description: Verify test BIDS dataset is accessible
    command: ls ${bids_dir}/dataset_description.json
    expected_output_contains: "dataset_description.json"

  - name: Participants file exists
    description: Verify participants.tsv is present
    command: ls ${bids_dir}/participants.tsv
    expected_output_contains: "participants.tsv"

  - name: T1w image accessible
    description: Verify T1-weighted image is accessible
    command: ls ${t1w}
    expected_output_contains: "T1w.nii.gz"

  - name: BOLD image accessible
    description: Verify BOLD time series is accessible
    command: ls ${bold}
    expected_output_contains: "bold.nii.gz"

  - name: Subject directory structure
    description: Verify BIDS subject directory structure
    command: ls -d ${bids_dir}/sub-02/anat ${bids_dir}/sub-02/func
    expected_output_contains: "anat"

  # ==========================================================================
  # SPM LIBRARY AND TOOLBOX VERIFICATION
  # ==========================================================================
  - name: SPM MCR toolbox directory
    description: Verify SPM toolbox directory structure
    command: ls /opt/spm12/spm12_mcr/toolbox/
    expected_exit_code: 0

  - name: SPM MCR spm12 directory
    description: Verify SPM12 MCR subdirectory exists
    command: ls /opt/spm12/spm12_mcr/spm12/
    expected_output_contains: "spm12"

  # ==========================================================================
  # PARTICIPANT-LEVEL PREPROCESSING (QUICK VALIDATION)
  # ==========================================================================
  - name: Participant level dry run syntax
    description: Verify participant level command parses correctly (check syntax only)
    command: |
      # Just verify the command structure is valid by checking help
      /opt/spm12/run.sh --help 2>&1 | grep -q "participant" && echo "Command syntax valid"
    expected_output_contains: "Command syntax valid"

  # ==========================================================================
  # FULL PARTICIPANT-LEVEL PIPELINE (LONG RUNNING)
  # ==========================================================================
  # WARNING: These tests are computationally intensive and may take 15-30 minutes

  - name: Participant preprocessing - single subject
    description: Run full fMRI preprocessing pipeline for one subject
    command: |
      /opt/spm12/run.sh ${bids_dir} ${output_dir}/bidsappspm_participant participant \
        --participant_label 02 \
        --skip-bids-validator 2>&1
    timeout: 1800
    validate:
      - output_exists: ${output_dir}/bidsappspm_participant/sub-02
    tags: [long_running, preprocessing]

  - name: Verify realignment output
    description: Check that motion-corrected mean image was created
    depends_on: Participant preprocessing - single subject
    command: ls ${output_dir}/bidsappspm_participant/sub-02/func/mean*.nii 2>/dev/null | head -1
    expected_output_contains: "mean"
    tags: [long_running]

  - name: Verify realignment parameters
    description: Check that motion parameters file was created
    depends_on: Participant preprocessing - single subject
    command: ls ${output_dir}/bidsappspm_participant/sub-02/func/rp_*.txt 2>/dev/null | head -1
    expected_output_contains: "rp_"
    tags: [long_running]

  - name: Verify segmentation output - gray matter
    description: Check that gray matter segmentation was created
    depends_on: Participant preprocessing - single subject
    command: ls ${output_dir}/bidsappspm_participant/sub-02/anat/c1*.nii 2>/dev/null | head -1
    expected_output_contains: "c1"
    tags: [long_running]

  - name: Verify segmentation output - white matter
    description: Check that white matter segmentation was created
    depends_on: Participant preprocessing - single subject
    command: ls ${output_dir}/bidsappspm_participant/sub-02/anat/c2*.nii 2>/dev/null | head -1
    expected_output_contains: "c2"
    tags: [long_running]

  - name: Verify segmentation output - CSF
    description: Check that CSF segmentation was created
    depends_on: Participant preprocessing - single subject
    command: ls ${output_dir}/bidsappspm_participant/sub-02/anat/c3*.nii 2>/dev/null | head -1
    expected_output_contains: "c3"
    tags: [long_running]

  - name: Verify deformation field
    description: Check that forward deformation field was created
    depends_on: Participant preprocessing - single subject
    command: ls ${output_dir}/bidsappspm_participant/sub-02/anat/y_*.nii 2>/dev/null | head -1
    expected_output_contains: "y_"
    tags: [long_running]

  - name: Verify bias-corrected T1
    description: Check that bias-corrected anatomical was created
    depends_on: Participant preprocessing - single subject
    command: ls ${output_dir}/bidsappspm_participant/sub-02/anat/m*T1w.nii 2>/dev/null | head -1
    expected_output_contains: "T1w"
    tags: [long_running]

  - name: Verify normalized functional
    description: Check that normalized (warped) functional was created
    depends_on: Participant preprocessing - single subject
    command: ls ${output_dir}/bidsappspm_participant/sub-02/func/w*.nii 2>/dev/null | head -1
    expected_output_contains: "w"
    tags: [long_running]

  - name: Verify smoothed functional
    description: Check that smoothed functional was created
    depends_on: Participant preprocessing - single subject
    command: ls ${output_dir}/bidsappspm_participant/sub-02/func/sw*.nii 2>/dev/null | head -1
    expected_output_contains: "sw"
    tags: [long_running]

  - name: Verify normalized anatomical
    description: Check that normalized anatomical was created
    depends_on: Participant preprocessing - single subject
    command: ls ${output_dir}/bidsappspm_participant/sub-02/anat/wm*.nii 2>/dev/null | head -1
    expected_output_contains: "wm"
    tags: [long_running]

  # ==========================================================================
  # GROUP-LEVEL ANALYSIS (requires participant level first)
  # ==========================================================================
  - name: Group analysis
    description: Run group-level analysis (mean T1w computation)
    depends_on: Participant preprocessing - single subject
    command: |
      /opt/spm12/run.sh ${bids_dir} ${output_dir}/bidsappspm_participant group \
        --skip-bids-validator 2>&1
    timeout: 600
    ignore_exit_code: true
    expected_output_contains: "SPM"
    tags: [long_running, group_analysis]

  - name: Verify group mean T1w
    description: Check that group-level output directory exists
    depends_on: Group analysis
    command: ls -d ${output_dir}/bidsappspm_participant
    expected_output_contains: "bidsappspm_participant"
    tags: [long_running]

  # ==========================================================================
  # MULTI-SUBJECT PROCESSING
  # ==========================================================================
  - name: Multi-subject preprocessing
    description: Process multiple subjects in parallel
    command: |
      /opt/spm12/run.sh ${bids_dir} ${output_dir}/bidsappspm_multi participant \
        --participant_label 02 03 \
        --skip-bids-validator 2>&1
    timeout: 3600
    validate:
      - output_exists: ${output_dir}/bidsappspm_multi/sub-02
      - output_exists: ${output_dir}/bidsappspm_multi/sub-03
    tags: [long_running, multi_subject]

  # ==========================================================================
  # ERROR HANDLING AND EDGE CASES
  # ==========================================================================
  - name: Handle missing T1w gracefully
    description: Check error handling when T1w is missing (sub-01)
    command: |
      /opt/spm12/run.sh ${bids_dir} ${output_dir}/bidsappspm_error participant \
        --participant_label 01 \
        --skip-bids-validator 2>&1 || true
    expected_output_contains: "does not exist"
    tags: [error_handling]

  - name: Handle empty participant list
    description: Verify all participants processed when no label specified
    command: |
      # Just verify the syntax - full run would take too long
      echo "No participant label means process all - syntax check only"
    expected_output_contains: "syntax check"

  # ==========================================================================
  # MCR RUNTIME TESTS
  # ==========================================================================
  - name: MCR runtime libraries
    description: Verify MCR runtime libraries are accessible
    command: ls /opt/mcr/v97/runtime/glnxa64/
    expected_output_contains: "."

  - name: MCR bin libraries
    description: Verify MCR bin libraries are accessible
    command: ls /opt/mcr/v97/bin/glnxa64/
    expected_output_contains: "."

  - name: LD_LIBRARY_PATH includes MCR
    description: Verify LD_LIBRARY_PATH is set for MCR
    command: echo $LD_LIBRARY_PATH
    expected_output_contains: "/opt/mcr/v97"

  # ==========================================================================
  # CONTAINER METADATA
  # ==========================================================================
  - name: Container README exists
    description: Verify container documentation is present
    command: cat /README.md
    expected_output_contains: "bidsappspm"

  - name: ReproEnv metadata
    description: Verify reproducibility environment metadata exists
    command: cat /.reproenv.json
    expected_output_contains: "."

  # ==========================================================================
  # SPM GUI (non-interactive verification)
  # ==========================================================================
  - name: SPM GUI option exists
    description: Verify --gui option is available (cannot run in headless mode)
    command: /opt/spm12/run.sh --help 2>&1 || true
    # Note: --gui option triggers SPM GUI which requires display
    # This test just verifies the container can parse GUI-related requests
    expected_output_contains: "Usage"

  # ==========================================================================
  # SPECIAL CHARACTERS AND PATH HANDLING
  # ==========================================================================
  - name: Paths with spaces handling
    description: Verify paths with spaces are handled (when properly quoted)
    command: |
      mkdir -p "${output_dir}/bidsappspm with spaces" && \
      echo "Directory with spaces created successfully" && \
      rm -rf "${output_dir}/bidsappspm with spaces"
    expected_output_contains: "successfully"

  # ==========================================================================
  # RESOURCE USAGE (informational)
  # ==========================================================================
  - name: Container size check
    description: Report container size for resource planning
    command: ls -lh /opt/spm12/spm12.ctf | awk '{print "CTF archive size:", $5}'
    expected_output_contains: "CTF archive size"

cleanup:
  script: |
    #!/usr/bin/env bash
    # Optionally remove test outputs
    # rm -rf ${output_dir}/bidsappspm*
    echo "Test outputs preserved in ${output_dir}/"
    echo "  - ${output_dir}/bidsappspm_participant/ (single subject results)"
    echo "  - ${output_dir}/bidsappspm_multi/ (multi-subject results)"
    echo ""
    echo "Note: Long-running tests may have been skipped."
    echo "Full preprocessing takes 15-30 minutes per subject."
