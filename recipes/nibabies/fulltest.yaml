# nibabies container test suite
# Tests for nibabies v24.0.0 - NiPreps infant fMRI preprocessing pipeline
#
# NiBabies is a robust preprocessing pipeline for infant MRI data (0-2 years).
# It builds on fMRIPrep's framework but adds infant-specific adaptations:
#   - Age-appropriate templates and atlases
#   - Infant-specific brain extraction and segmentation
#   - Support for infant surface reconstruction (infantFS, MCRIBS)
#
# Test data: ds000001/sub-01 (OpenNeuro Balloon Analog Risk-taking Task)
#   - T1w: 160x192x192, 1x1.33x1.33mm (3D structural)
#   - BOLD: 64x64x33x300, 3.125x3.125x4mm, TR=2s (4D functional)
#
# Note: Full nibabies pipeline tests require substantial compute resources
# and FreeSurfer license. These tests focus on individual tool verification.

name: nibabies
version: 24.0.0
container: nibabies_24.0.0_20260122.simg

required_files:
  - dataset: ds000001
    files:
      - sub-01/anat/sub-01_T1w.nii.gz
      - sub-01/anat/sub-01_inplaneT2.nii.gz
      - sub-01/func/sub-01_task-balloonanalogrisktask_run-01_bold.nii.gz

test_data:
  t1w: ds000001/sub-01/anat/sub-01_T1w.nii.gz
  t2: ds000001/sub-01/anat/sub-01_inplaneT2.nii.gz
  bold: ds000001/sub-01/func/sub-01_task-balloonanalogrisktask_run-01_bold.nii.gz
  bids_dir: ds000001
  output_dir: test_output

setup:
  script: |
    #!/usr/bin/env bash
    set -e
    mkdir -p test_output
    mkdir -p test_output/ants
    mkdir -p test_output/fsl
    mkdir -p test_output/freesurfer
    mkdir -p test_output/workbench

tests:
  # ==========================================================================
  # NIBABIES MAIN COMMAND
  # ==========================================================================
  - name: NiBabies version check
    description: Verify nibabies binary runs and reports version
    command: nibabies --version 2>&1
    expected_output_contains: "NiBabies"

  - name: NiBabies help output
    description: Verify nibabies help is accessible
    command: nibabies --help 2>&1 | head -20
    expected_output_contains: "NiBabies"

  # ==========================================================================
  # BIDS VALIDATION
  # ==========================================================================
  - name: BIDS validator version
    description: Verify bids-validator is available
    command: bids-validator --version 2>&1
    expected_exit_code: 0

  - name: BIDS validator help
    description: Check bids-validator help output
    command: bids-validator --help 2>&1 | head -5
    expected_output_contains: "bids-validator"

  # ==========================================================================
  # FSL TOOLS - Basic Operations
  # ==========================================================================
  - name: FSL info on T1w
    description: Test fslinfo to read NIfTI header
    command: fslinfo ${t1w}
    expected_output_contains: "dim1"

  - name: FSL info on BOLD
    description: Test fslinfo on 4D functional data
    command: fslinfo ${bold}
    expected_output_contains: "dim4"

  - name: FSL header dump
    description: Test fslhd for detailed header info
    command: fslhd ${t1w} | head -20
    expected_output_contains: "sizeof_hdr"

  - name: FSL stats on T1w
    description: Compute basic statistics on T1w image
    command: fslstats ${t1w} -R -m -s
    expected_exit_code: 0

  - name: FSL stats robust range
    description: Compute robust intensity range
    command: fslstats ${t1w} -r
    expected_exit_code: 0

  - name: FSL stats on BOLD mean
    description: Compute temporal mean stats on BOLD
    command: fslstats ${bold} -M
    expected_exit_code: 0

  # ==========================================================================
  # FSL TOOLS - Image Mathematics
  # ==========================================================================
  - name: FSL maths binarize
    description: Test fslmaths binarization
    command: fslmaths ${t1w} -bin test_output/fsl/t1w_bin.nii.gz
    validate:
      - output_exists: ${output_dir}/fsl/t1w_bin.nii.gz

  - name: FSL maths threshold
    description: Test fslmaths thresholding
    command: fslmaths ${t1w} -thr 100 test_output/fsl/t1w_thr100.nii.gz
    validate:
      - output_exists: ${output_dir}/fsl/t1w_thr100.nii.gz

  - name: FSL maths smoothing
    description: Test fslmaths Gaussian smoothing (2mm sigma)
    command: fslmaths ${t1w} -s 2 test_output/fsl/t1w_smooth2mm.nii.gz
    validate:
      - output_exists: ${output_dir}/fsl/t1w_smooth2mm.nii.gz

  - name: FSL maths temporal mean
    description: Compute temporal mean of BOLD
    command: fslmaths ${bold} -Tmean test_output/fsl/bold_tmean.nii.gz
    validate:
      - output_exists: ${output_dir}/fsl/bold_tmean.nii.gz

  - name: FSL maths temporal std
    description: Compute temporal standard deviation of BOLD
    command: fslmaths ${bold} -Tstd test_output/fsl/bold_tstd.nii.gz
    validate:
      - output_exists: ${output_dir}/fsl/bold_tstd.nii.gz

  - name: FSL maths multiply
    description: Test fslmaths multiplication
    command: fslmaths ${t1w} -mul 2 test_output/fsl/t1w_mul2.nii.gz
    validate:
      - output_exists: ${output_dir}/fsl/t1w_mul2.nii.gz

  - name: FSL maths add
    description: Test fslmaths addition
    command: fslmaths ${t1w} -add 100 test_output/fsl/t1w_add100.nii.gz
    validate:
      - output_exists: ${output_dir}/fsl/t1w_add100.nii.gz

  - name: FSL maths divide
    description: Test fslmaths division
    command: fslmaths ${t1w} -div 2 test_output/fsl/t1w_div2.nii.gz
    validate:
      - output_exists: ${output_dir}/fsl/t1w_div2.nii.gz

  - name: FSL maths erosion
    description: Test fslmaths morphological erosion
    command: fslmaths ${t1w} -thr 100 -bin -ero test_output/fsl/t1w_ero.nii.gz
    validate:
      - output_exists: ${output_dir}/fsl/t1w_ero.nii.gz

  - name: FSL maths dilation
    description: Test fslmaths morphological dilation
    command: fslmaths ${t1w} -thr 100 -bin -dilM test_output/fsl/t1w_dilM.nii.gz
    validate:
      - output_exists: ${output_dir}/fsl/t1w_dilM.nii.gz

  - name: FSL maths fill holes
    description: Test fslmaths fill holes
    command: fslmaths ${t1w} -thr 100 -bin -fillh test_output/fsl/t1w_fillh.nii.gz
    validate:
      - output_exists: ${output_dir}/fsl/t1w_fillh.nii.gz

  # ==========================================================================
  # FSL TOOLS - Brain Extraction (BET)
  # ==========================================================================
  - name: BET brain extraction
    description: Test FSL BET brain extraction
    command: bet ${t1w} test_output/fsl/t1w_brain.nii.gz -f 0.5 -g 0
    validate:
      - output_exists: ${output_dir}/fsl/t1w_brain.nii.gz

  - name: BET with mask output
    description: Test BET with binary mask generation
    command: bet ${t1w} test_output/fsl/t1w_brain_mask -m -f 0.5
    validate:
      - output_exists: ${output_dir}/fsl/t1w_brain_mask.nii.gz
      - output_exists: ${output_dir}/fsl/t1w_brain_mask_mask.nii.gz

  - name: BET robust center estimation
    description: Test BET with robust center estimation (dc command missing from container)
    command: bet ${t1w} test_output/fsl/t1w_brain_robust.nii.gz -R -f 0.5 2>&1
    ignore_exit_code: true
    expected_output_contains: "bet"

  # ==========================================================================
  # FSL TOOLS - FLIRT (Linear Registration)
  # ==========================================================================
  - name: FLIRT help
    description: Verify FLIRT is available
    command: flirt -version 2>&1
    expected_output_contains: "FLIRT"

  - name: FLIRT self-registration
    description: Test FLIRT registration with identity transform
    command: flirt -in ${t1w} -ref ${t1w} -omat test_output/fsl/t1w_identity.mat -dof 6
    validate:
      - output_exists: ${output_dir}/fsl/t1w_identity.mat

  - name: FLIRT T2 to T1 registration
    description: Register inplane T2 to T1w
    command: flirt -in ${t2} -ref ${t1w} -out test_output/fsl/t2_to_t1w.nii.gz -omat test_output/fsl/t2_to_t1w.mat -dof 6
    validate:
      - output_exists: ${output_dir}/fsl/t2_to_t1w.nii.gz
      - output_exists: ${output_dir}/fsl/t2_to_t1w.mat

  - name: FLIRT apply transform
    description: Apply existing transform to image
    command: flirt -in ${t2} -ref ${t1w} -applyxfm -init test_output/fsl/t2_to_t1w.mat -out test_output/fsl/t2_to_t1w_applied.nii.gz
    depends_on: FLIRT T2 to T1 registration
    validate:
      - output_exists: ${output_dir}/fsl/t2_to_t1w_applied.nii.gz

  # ==========================================================================
  # FSL TOOLS - FAST (Tissue Segmentation)
  # ==========================================================================
  - name: FAST segmentation
    description: Test FSL FAST tissue segmentation
    command: fast -t 1 -n 3 -o test_output/fsl/t1w_fast test_output/fsl/t1w_brain.nii.gz
    depends_on: BET brain extraction
    validate:
      - output_exists: ${output_dir}/fsl/t1w_fast_seg.nii.gz
      - output_exists: ${output_dir}/fsl/t1w_fast_pve_0.nii.gz
      - output_exists: ${output_dir}/fsl/t1w_fast_pve_1.nii.gz
      - output_exists: ${output_dir}/fsl/t1w_fast_pve_2.nii.gz

  - name: FAST with bias correction
    description: Test FAST with bias field output
    command: fast -t 1 -n 3 -b -B -o test_output/fsl/t1w_fast_bias test_output/fsl/t1w_brain.nii.gz
    depends_on: BET brain extraction
    validate:
      - output_exists: ${output_dir}/fsl/t1w_fast_bias_seg.nii.gz
      - output_exists: ${output_dir}/fsl/t1w_fast_bias_restore.nii.gz

  # ==========================================================================
  # FSL TOOLS - MCFLIRT (Motion Correction)
  # ==========================================================================
  - name: MCFLIRT motion correction
    description: Test FSL MCFLIRT motion correction on BOLD
    command: mcflirt -in ${bold} -out test_output/fsl/bold_mcf -plots -report
    validate:
      - output_exists: ${output_dir}/fsl/bold_mcf.nii.gz
      - output_exists: ${output_dir}/fsl/bold_mcf.par

  - name: MCFLIRT with mean volume reference
    description: Test MCFLIRT with mean volume as reference
    command: mcflirt -in ${bold} -out test_output/fsl/bold_mcf_meanvol -meanvol -plots
    validate:
      - output_exists: ${output_dir}/fsl/bold_mcf_meanvol.nii.gz
      - output_exists: ${output_dir}/fsl/bold_mcf_meanvol.par

  # ==========================================================================
  # ANTs TOOLS - Bias Field Correction
  # ==========================================================================
  - name: N4 bias field correction
    description: Test ANTs N4BiasFieldCorrection
    command: N4BiasFieldCorrection -d 3 -i ${t1w} -o test_output/ants/t1w_n4.nii.gz -s 4 -c [50x50x50x50,0.0]
    validate:
      - output_exists: ${output_dir}/ants/t1w_n4.nii.gz

  - name: N4 with bias field output
    description: Test N4 with bias field output
    command: N4BiasFieldCorrection -d 3 -i ${t1w} -o [test_output/ants/t1w_n4_full.nii.gz,test_output/ants/t1w_bias_field.nii.gz] -s 4 -c [50x50x50x50,0.0]
    validate:
      - output_exists: ${output_dir}/ants/t1w_n4_full.nii.gz
      - output_exists: ${output_dir}/ants/t1w_bias_field.nii.gz

  # ==========================================================================
  # ANTs TOOLS - Image Denoising
  # ==========================================================================
  - name: ANTs denoise image
    description: Test ANTs DenoiseImage
    command: DenoiseImage -d 3 -i ${t1w} -o test_output/ants/t1w_denoised.nii.gz -s 1
    validate:
      - output_exists: ${output_dir}/ants/t1w_denoised.nii.gz

  - name: ANTs denoise with noise model
    description: Test DenoiseImage with Rician noise model
    command: DenoiseImage -d 3 -i ${t1w} -o test_output/ants/t1w_denoised_rician.nii.gz -n Rician -s 2
    validate:
      - output_exists: ${output_dir}/ants/t1w_denoised_rician.nii.gz

  # ==========================================================================
  # ANTs TOOLS - Registration
  # ==========================================================================
  - name: ANTs registration help
    description: Verify antsRegistration is available
    command: antsRegistration --version 2>&1
    expected_output_contains: "ANTs"

  - name: ANTs affine registration
    description: Test antsRegistration affine (T2 to T1)
    command: |
      antsRegistration -d 3 -v 0 \
        -o [test_output/ants/t2_to_t1_,test_output/ants/t2_to_t1_warped.nii.gz] \
        -t Rigid[0.1] \
        -m MI[${t1w},${t2},1,32,Regular,0.25] \
        -c [100x50x25,1e-6,10] \
        -s 2x1x0vox \
        -f 4x2x1
    validate:
      - output_exists: ${output_dir}/ants/t2_to_t1_warped.nii.gz
      - output_exists: ${output_dir}/ants/t2_to_t1_0GenericAffine.mat

  - name: ANTs apply transforms
    description: Test antsApplyTransforms
    command: |
      antsApplyTransforms -d 3 \
        -i ${t2} \
        -r ${t1w} \
        -t test_output/ants/t2_to_t1_0GenericAffine.mat \
        -o test_output/ants/t2_applied.nii.gz \
        -n Linear
    depends_on: ANTs affine registration
    validate:
      - output_exists: ${output_dir}/ants/t2_applied.nii.gz

  # ==========================================================================
  # ANTs TOOLS - Segmentation
  # ==========================================================================
  - name: ANTs Atropos segmentation
    description: Test ANTs Atropos tissue segmentation
    command: |
      Atropos -d 3 \
        -a ${t1w} \
        -x test_output/fsl/t1w_brain_mask_mask.nii.gz \
        -i kmeans[3] \
        -o [test_output/ants/t1w_atropos_seg.nii.gz,test_output/ants/t1w_atropos_prob%02d.nii.gz] \
        -c [3,0.0] \
        -m [0.1,1x1x1] \
        -k Gaussian
    depends_on: BET with mask output
    validate:
      - output_exists: ${output_dir}/ants/t1w_atropos_seg.nii.gz

  # ==========================================================================
  # ANTs TOOLS - Image Math
  # ==========================================================================
  - name: ANTs ImageMath multiply
    description: Test ANTs ImageMath multiplication
    command: ImageMath 3 test_output/ants/t1w_mul2.nii.gz m ${t1w} 2
    validate:
      - output_exists: ${output_dir}/ants/t1w_mul2.nii.gz

  - name: ANTs ImageMath smooth
    description: Test ANTs ImageMath Gaussian smoothing
    command: ImageMath 3 test_output/ants/t1w_smooth.nii.gz G ${t1w} 2
    validate:
      - output_exists: ${output_dir}/ants/t1w_smooth.nii.gz

  - name: ANTs ImageMath morphological dilation
    description: Test ANTs ImageMath dilation
    command: ImageMath 3 test_output/ants/mask_dilated.nii.gz MD test_output/fsl/t1w_brain_mask_mask.nii.gz 2
    depends_on: BET with mask output
    validate:
      - output_exists: ${output_dir}/ants/mask_dilated.nii.gz

  - name: ANTs ImageMath morphological erosion
    description: Test ANTs ImageMath erosion
    command: ImageMath 3 test_output/ants/mask_eroded.nii.gz ME test_output/fsl/t1w_brain_mask_mask.nii.gz 2
    depends_on: BET with mask output
    validate:
      - output_exists: ${output_dir}/ants/mask_eroded.nii.gz

  # ==========================================================================
  # ANTs TOOLS - Motion Correction
  # ==========================================================================
  - name: ANTs motion correction
    description: Test ANTs antsMotionCorr on BOLD (first 10 volumes)
    command: |
      fslroi ${bold} test_output/ants/bold_10vol.nii.gz 0 10 && \
      antsMotionCorr -d 3 -a test_output/ants/bold_10vol.nii.gz -o test_output/ants/bold_avg.nii.gz
    validate:
      - output_exists: ${output_dir}/ants/bold_avg.nii.gz

  # ==========================================================================
  # FREESURFER TOOLS
  # ==========================================================================
  - name: FreeSurfer mri_convert help
    description: Verify mri_convert is available
    command: mri_convert --help 2>&1 | head -5
    expected_output_contains: "mri_convert"

  - name: FreeSurfer mri_convert NIfTI to MGZ
    description: Convert NIfTI to MGZ format (requires FreeSurfer license)
    command: mri_convert ${t1w} test_output/freesurfer/t1w.mgz 2>&1
    ignore_exit_code: true
    expected_output_contains: "reading from"

  - name: FreeSurfer mri_convert MGZ to NIfTI
    description: Convert MGZ back to NIfTI (requires FreeSurfer license)
    command: mri_convert test_output/freesurfer/t1w.mgz test_output/freesurfer/t1w_from_mgz.nii.gz 2>&1
    ignore_exit_code: true
    expected_output_contains: "mri_convert"

  - name: FreeSurfer mri_convert reorient
    description: Reorient image to standard RAS (requires FreeSurfer license)
    command: mri_convert ${t1w} test_output/freesurfer/t1w_ras.nii.gz --out_orientation RAS 2>&1
    ignore_exit_code: true
    expected_output_contains: "reading from"

  - name: FreeSurfer mri_convert conform
    description: Conform image to 1mm isotropic (requires FreeSurfer license)
    command: mri_convert ${t1w} test_output/freesurfer/t1w_conformed.mgz -c 2>&1
    ignore_exit_code: true
    expected_output_contains: "reading from"

  - name: FreeSurfer mri_info
    description: Test mri_info to get volume information
    command: mri_info ${t1w} 2>&1 | head -20
    expected_output_contains: "dimensions"

  # ==========================================================================
  # CONNECTOME WORKBENCH
  # ==========================================================================
  - name: Workbench version
    description: Verify wb_command is available
    command: wb_command -version 2>&1
    expected_output_contains: "Workbench"

  - name: Workbench information
    description: Get volume information using wb_command
    command: wb_command -volume-stats ${t1w} -reduce MEAN 2>&1
    expected_exit_code: 0

  - name: Workbench volume math multiply
    description: Test wb_command volume math
    command: wb_command -volume-math "x * 2" test_output/workbench/t1w_mul2.nii.gz -var x ${t1w}
    validate:
      - output_exists: ${output_dir}/workbench/t1w_mul2.nii.gz

  - name: Workbench volume smoothing
    description: Test wb_command volume smoothing
    command: wb_command -volume-smoothing ${t1w} 2 test_output/workbench/t1w_smooth.nii.gz
    validate:
      - output_exists: ${output_dir}/workbench/t1w_smooth.nii.gz

  - name: Workbench volume reduce mean
    description: Test wb_command volume reduce (temporal mean)
    command: wb_command -volume-reduce ${bold} MEAN test_output/workbench/bold_mean.nii.gz
    validate:
      - output_exists: ${output_dir}/workbench/bold_mean.nii.gz

  - name: Workbench volume reduce stdev
    description: Test wb_command volume reduce (temporal stdev)
    command: wb_command -volume-reduce ${bold} STDEV test_output/workbench/bold_stdev.nii.gz
    validate:
      - output_exists: ${output_dir}/workbench/bold_stdev.nii.gz

  - name: Workbench volume dilate
    description: Test wb_command volume dilation
    command: |
      fslmaths ${t1w} -thr 100 -bin test_output/workbench/t1w_mask.nii.gz && \
      wb_command -volume-dilate test_output/workbench/t1w_mask.nii.gz 2 NEAREST test_output/workbench/t1w_mask_dilated.nii.gz
    validate:
      - output_exists: ${output_dir}/workbench/t1w_mask_dilated.nii.gz

  # ==========================================================================
  # PIPELINE COMPONENT TESTS
  # ==========================================================================
  - name: Compute tSNR
    description: Compute temporal signal-to-noise ratio
    command: |
      fslmaths ${bold} -Tmean test_output/bold_mean_tsnr.nii.gz && \
      fslmaths ${bold} -Tstd test_output/bold_std_tsnr.nii.gz && \
      fslmaths test_output/bold_mean_tsnr.nii.gz -div test_output/bold_std_tsnr.nii.gz test_output/bold_tsnr.nii.gz
    validate:
      - output_exists: ${output_dir}/bold_tsnr.nii.gz

  - name: BOLD to T1 preparation
    description: Prepare BOLD for registration (extract middle volume)
    command: |
      nvols=$(fslnvols ${bold}) && \
      midvol=$((nvols / 2)) && \
      fslroi ${bold} test_output/bold_ref.nii.gz $midvol 1
    validate:
      - output_exists: ${output_dir}/bold_ref.nii.gz

  - name: Basic preprocessing chain - denoising and bias correction
    description: Chain ANTs denoising and N4 bias correction
    command: |
      DenoiseImage -d 3 -i ${t1w} -o test_output/t1w_preproc_denoised.nii.gz -s 2 && \
      N4BiasFieldCorrection -d 3 -i test_output/t1w_preproc_denoised.nii.gz -o test_output/t1w_preproc_n4.nii.gz -s 4 -c [50x50x50,0.0]
    validate:
      - output_exists: ${output_dir}/t1w_preproc_n4.nii.gz

  - name: Basic preprocessing chain - brain extraction and segmentation
    description: Chain BET and FAST
    command: |
      bet test_output/t1w_preproc_n4.nii.gz test_output/t1w_preproc_brain.nii.gz -m -f 0.4 && \
      fast -t 1 -n 3 -o test_output/t1w_preproc_fast test_output/t1w_preproc_brain.nii.gz
    depends_on: Basic preprocessing chain - denoising and bias correction
    validate:
      - output_exists: ${output_dir}/t1w_preproc_brain.nii.gz
      - output_exists: ${output_dir}/t1w_preproc_fast_seg.nii.gz

  # ==========================================================================
  # BOLD PREPROCESSING COMPONENTS
  # ==========================================================================
  - name: BOLD temporal filtering
    description: High-pass temporal filter on BOLD
    command: fslmaths ${bold} -bptf 25 -1 test_output/bold_hpf.nii.gz
    validate:
      - output_exists: ${output_dir}/bold_hpf.nii.gz

  - name: BOLD spatial smoothing
    description: Spatial smoothing on BOLD (6mm FWHM)
    command: fslmaths ${bold} -s 2.548 test_output/bold_smooth6mm.nii.gz
    validate:
      - output_exists: ${output_dir}/bold_smooth6mm.nii.gz

  - name: BOLD intensity normalization
    description: Grand mean scaling of BOLD
    command: |
      fslmaths ${bold} -Tmean test_output/bold_mean_norm.nii.gz && \
      mean_val=$(fslstats test_output/bold_mean_norm.nii.gz -M) && \
      fslmaths ${bold} -div $mean_val -mul 10000 test_output/bold_normalized.nii.gz
    validate:
      - output_exists: ${output_dir}/bold_normalized.nii.gz

  # ==========================================================================
  # OUTPUT DATA TYPE TESTS
  # ==========================================================================
  - name: FSL output as float
    description: Test fslmaths output data type float
    command: fslmaths ${t1w} test_output/t1w_float.nii.gz -odt float
    expected_exit_code: 0
    validate:
      - output_exists: ${output_dir}/t1w_float.nii.gz

  - name: FSL output as short
    description: Test fslmaths output data type short
    command: fslmaths ${t1w} test_output/t1w_short.nii.gz -odt short
    expected_exit_code: 0
    validate:
      - output_exists: ${output_dir}/t1w_short.nii.gz

  # ==========================================================================
  # VERIFICATION TESTS
  # ==========================================================================
  - name: Verify brain extraction quality
    description: Check that brain extraction produced reasonable output
    command: |
      orig_vol=$(fslstats ${t1w} -V | awk '{print $1}') && \
      brain_vol=$(fslstats test_output/fsl/t1w_brain.nii.gz -V | awk '{print $1}') && \
      ratio=$(echo "scale=2; $brain_vol / $orig_vol" | bc) && \
      echo "Brain/Original volume ratio: $ratio"
    depends_on: BET brain extraction
    expected_exit_code: 0

  - name: Verify motion parameters
    description: Check motion correction parameters file format
    command: |
      head -5 test_output/fsl/bold_mcf.par && \
      wc -l test_output/fsl/bold_mcf.par
    depends_on: MCFLIRT motion correction
    expected_exit_code: 0

  - name: Verify registration transform
    description: Check that ANTs transform file is valid
    command: antsTransformInfo test_output/ants/t2_to_t1_0GenericAffine.mat
    depends_on: ANTs affine registration
    expected_exit_code: 0

cleanup:
  script: |
    #!/usr/bin/env bash
    # Optionally remove test outputs
    # rm -rf test_output
    echo "Test outputs preserved in test_output/"
