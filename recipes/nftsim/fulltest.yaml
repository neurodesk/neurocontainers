# nftsim container test suite
# Tests for nftsim v1.0.2 - Neural Field Theory Simulation Framework
#
# NFTsim is a neural field simulation framework for large-scale brain dynamics.
# It simulates various neural models including corticothalamic and cortical
# circuits using configuration files.
#
# Note: nftsim uses its own configuration files and does not process neuroimaging
# data directly. Test data paths reference built-in config files from the container.

name: nftsim
version: 1.0.2
container: nftsim_1.0.2_20250725.simg

test_data:
  # Built-in configuration files from the container
  eirs_corticothalamic: /app/configs/eirs-corticothalamic.conf
  e_cortical: /app/configs/e-cortical.conf
  ei_cortical: /app/configs/ei-cortical.conf
  stimuli_only: /app/configs/stimuli-only.conf
  eirs_burst: /app/configs/eirs-burst.conf
  eirs_aerp: /app/configs/eirs-aerp.conf
  eirs_tms: /app/configs/eirs-tms.conf
  emirs: /app/configs/emirs.conf
  eirs_coupling_ramp: /app/configs/eirs-coupling-ramp.conf
  eirs_dendrite_integral: /app/configs/eirs-dendrite-integral.conf
  e_coupling_matrix: /app/configs/e-coupling-matrix.conf
  e_erps: /app/configs/e-erps.conf
  e_erps_all_nodes: /app/configs/e-erps-all-nodes.conf
  stimulus_test_white: /app/configs/stimulus-test-white.conf
  test_coupling_map: /app/configs/test_coupling_map.conf
  test_coupling_ramp: /app/configs/test_coupling_ramp.conf
  test_time_validation: /app/configs/test_time-validation.conf
  # Plasticity configs
  plasticity_bcm: /app/configs/Plasticity/bcm.conf
  plasticity_bihemispheric: /app/configs/Plasticity/bihemispheric.conf
  plasticity_eirs_bcm: /app/configs/Plasticity/eirs-bcm.conf
  plasticity_marcus: /app/configs/Plasticity/marcus.conf
  plasticity_network: /app/configs/Plasticity/network.conf
  plasticity_pas: /app/configs/Plasticity/pas.conf
  plasticity_plasticity: /app/configs/Plasticity/plasticity.conf
  plasticity_rtms: /app/configs/Plasticity/rtms.conf
  plasticity_tbs: /app/configs/Plasticity/tbs.conf
  # TMS configs
  tms_teps_bi: /app/configs/TMS/teps-bi.conf
  tms_teps_gabab: /app/configs/TMS/teps-gabab.conf
  tms_teps_mono: /app/configs/TMS/teps-mono.conf
  # Published configs
  abeysuriya_figure1: /app/configs/Published/Abeysuriya_2014/figure_1.conf
  abeysuriya_figure2: /app/configs/Published/Abeysuriya_2014/figure_2.conf
  output_dir: test_output

setup:
  script: |
    #!/usr/bin/env bash
    set -e
    mkdir -p test_output

tests:
  # ==========================================================================
  # BASIC FUNCTIONALITY
  # ==========================================================================
  - name: Help output
    description: Verify nftsim binary runs and displays help information
    command: nftsim --help 2>&1
    expected_output_contains: "Usage: nftsim"

  - name: Help flag short form
    description: Verify short help flag works
    command: nftsim -h 2>&1
    expected_output_contains: "Usage: nftsim"

  - name: Help flag alternative
    description: Verify alternative help flag works
    command: nftsim -? 2>&1
    expected_output_contains: "Usage: nftsim"

  - name: Check config file exists
    description: Verify default config file is accessible
    command: ls -la ${eirs_corticothalamic}
    expected_exit_code: 0

  # ==========================================================================
  # CORTICOTHALAMIC MODEL SIMULATIONS
  # ==========================================================================
  - name: EIRS corticothalamic simulation
    description: Run the main Robinson et al. corticothalamic model (EIRS - Excitatory, Inhibitory, Reticular, Relay)
    command: nftsim -i ${eirs_corticothalamic} -o test_output/eirs-corticothalamic.output
    validate:
      - output_exists: ${output_dir}/eirs-corticothalamic.output

  - name: Verify EIRS output contains time series
    description: Check that the output contains simulation time series data
    command: grep -c "Time" test_output/eirs-corticothalamic.output || echo "0"
    depends_on: EIRS corticothalamic simulation
    expected_output_contains: "2"

  - name: EIRS burst simulation
    description: Run EIRS model with burst dynamics configuration
    command: nftsim -i ${eirs_burst} -o test_output/eirs-burst.output
    validate:
      - output_exists: ${output_dir}/eirs-burst.output

  - name: EIRS AERP simulation
    description: Run EIRS model for Auditory Evoked Response Potential simulation
    command: nftsim -i ${eirs_aerp} -o test_output/eirs-aerp.output
    validate:
      - output_exists: ${output_dir}/eirs-aerp.output

  - name: EIRS TMS simulation
    description: Run EIRS model with TMS (Transcranial Magnetic Stimulation) configuration
    command: nftsim -i ${eirs_tms} -o test_output/eirs-tms.output
    timeout: 600
    validate:
      - output_exists: ${output_dir}/eirs-tms.output

  - name: EIRS coupling ramp
    description: Run EIRS model with ramp coupling dynamics
    command: nftsim -i ${eirs_coupling_ramp} -o test_output/eirs-coupling-ramp.output
    validate:
      - output_exists: ${output_dir}/eirs-coupling-ramp.output

  - name: EIRS dendrite integral
    description: Run EIRS model with dendrite integral dynamics
    command: nftsim -i ${eirs_dendrite_integral} -o test_output/eirs-dendrite-integral.output
    validate:
      - output_exists: ${output_dir}/eirs-dendrite-integral.output

  - name: EMIRS simulation
    description: Run EMIRS model (Extended EIRS with additional population)
    command: nftsim -i ${emirs} -o test_output/emirs.output
    validate:
      - output_exists: ${output_dir}/emirs.output

  # ==========================================================================
  # CORTICAL MODEL SIMULATIONS
  # ==========================================================================
  - name: E cortical simulation
    description: Run single excitatory population cortical model with wave propagator
    command: nftsim -i ${e_cortical} -o test_output/e-cortical.output
    validate:
      - output_exists: ${output_dir}/e-cortical.output

  - name: EI cortical simulation
    description: Run excitatory-inhibitory cortical model on rectangular sheet
    command: nftsim -i ${ei_cortical} -o test_output/ei-cortical.output
    validate:
      - output_exists: ${output_dir}/ei-cortical.output

  - name: E coupling matrix
    description: Run excitatory model with coupling matrix configuration
    command: nftsim -i ${e_coupling_matrix} -o test_output/e-coupling-matrix.output
    validate:
      - output_exists: ${output_dir}/e-coupling-matrix.output

  - name: E ERPs simulation
    description: Run excitatory model for Event-Related Potentials
    command: nftsim -i ${e_erps} -o test_output/e-erps.output
    validate:
      - output_exists: ${output_dir}/e-erps.output

  - name: E ERPs all nodes
    description: Run excitatory model for ERPs with all node output
    command: nftsim -i ${e_erps_all_nodes} -o test_output/e-erps-all-nodes.output
    validate:
      - output_exists: ${output_dir}/e-erps-all-nodes.output

  # ==========================================================================
  # STIMULUS CONFIGURATIONS
  # ==========================================================================
  - name: Stimuli only simulation
    description: Run simulation with superimposed pulse stimuli (PulseRect and PulseSigmoid)
    command: nftsim -i ${stimuli_only} -o test_output/stimuli-only.output
    validate:
      - output_exists: ${output_dir}/stimuli-only.output

  - name: White noise stimulus test
    description: Run simulation with white noise stimulus configuration
    command: nftsim -i ${stimulus_test_white} -o test_output/stimulus-test-white.output
    validate:
      - output_exists: ${output_dir}/stimulus-test-white.output

  # ==========================================================================
  # COUPLING TESTS
  # ==========================================================================
  - name: Coupling map test
    description: Test coupling map configuration
    command: nftsim -i ${test_coupling_map} -o test_output/test-coupling-map.output
    validate:
      - output_exists: ${output_dir}/test-coupling-map.output

  - name: Coupling ramp test
    description: Test coupling ramp configuration (crashes with SIGABRT - container bug)
    command: nftsim -i ${test_coupling_ramp} -o test_output/test-coupling-ramp.output 2>&1 || true
    ignore_exit_code: true

  # ==========================================================================
  # TIME VALIDATION
  # ==========================================================================
  - name: Time validation test
    description: Test time stepping and validation configuration
    command: nftsim -i ${test_time_validation} -o test_output/test-time-validation.output
    validate:
      - output_exists: ${output_dir}/test-time-validation.output

  # ==========================================================================
  # PLASTICITY SIMULATIONS
  # ==========================================================================
  - name: BCM plasticity
    description: Run Bienenstock-Cooper-Munro plasticity model
    command: nftsim -i ${plasticity_bcm} -o test_output/plasticity-bcm.output
    validate:
      - output_exists: ${output_dir}/plasticity-bcm.output

  - name: Bihemispheric plasticity
    description: Run bihemispheric plasticity model
    command: nftsim -i ${plasticity_bihemispheric} -o test_output/plasticity-bihemispheric.output
    validate:
      - output_exists: ${output_dir}/plasticity-bihemispheric.output

  - name: EIRS BCM plasticity
    description: Run EIRS model with BCM plasticity
    command: nftsim -i ${plasticity_eirs_bcm} -o test_output/plasticity-eirs-bcm.output
    validate:
      - output_exists: ${output_dir}/plasticity-eirs-bcm.output

  - name: Marcus plasticity
    description: Run Marcus plasticity configuration
    command: nftsim -i ${plasticity_marcus} -o test_output/plasticity-marcus.output
    validate:
      - output_exists: ${output_dir}/plasticity-marcus.output

  - name: Network plasticity
    description: Run network plasticity model
    command: nftsim -i ${plasticity_network} -o test_output/plasticity-network.output
    validate:
      - output_exists: ${output_dir}/plasticity-network.output

  - name: PAS plasticity
    description: Run PAS plasticity model (fCaP coupling type not available in this version)
    command: nftsim -i ${plasticity_pas} -o test_output/plasticity-pas.output 2>&1
    ignore_exit_code: true
    expected_output_contains: "fCaP"

  - name: Basic plasticity
    description: Run basic plasticity configuration
    command: nftsim -i ${plasticity_plasticity} -o test_output/plasticity-plasticity.output
    validate:
      - output_exists: ${output_dir}/plasticity-plasticity.output

  - name: rTMS plasticity
    description: Run repetitive TMS plasticity model
    command: nftsim -i ${plasticity_rtms} -o test_output/plasticity-rtms.output
    validate:
      - output_exists: ${output_dir}/plasticity-rtms.output

  - name: TBS plasticity
    description: Run Theta Burst Stimulation plasticity model
    command: nftsim -i ${plasticity_tbs} -o test_output/plasticity-tbs.output
    validate:
      - output_exists: ${output_dir}/plasticity-tbs.output

  # ==========================================================================
  # TMS SIMULATIONS
  # ==========================================================================
  - name: TEPs bihemispheric
    description: Run TMS-evoked potentials bihemispheric model
    command: nftsim -i ${tms_teps_bi} -o test_output/tms-teps-bi.output
    validate:
      - output_exists: ${output_dir}/tms-teps-bi.output

  - name: TEPs GABA-B
    description: Run TMS-evoked potentials with GABA-B dynamics
    command: nftsim -i ${tms_teps_gabab} -o test_output/tms-teps-gabab.output
    validate:
      - output_exists: ${output_dir}/tms-teps-gabab.output

  - name: TEPs monohemispheric
    description: Run TMS-evoked potentials monohemispheric model
    command: nftsim -i ${tms_teps_mono} -o test_output/tms-teps-mono.output
    validate:
      - output_exists: ${output_dir}/tms-teps-mono.output

  # ==========================================================================
  # PUBLISHED CONFIGURATIONS (Abeysuriya et al. 2014)
  # ==========================================================================
  - name: Abeysuriya 2014 Figure 1 config check
    description: Verify Abeysuriya 2014 Figure 1 config file is valid and readable
    command: cat ${abeysuriya_figure1} | head -5
    expected_output_contains: "Connection"

  - name: Abeysuriya 2014 Figure 2 config check
    description: Verify Abeysuriya 2014 Figure 2 config file is valid and readable
    command: cat ${abeysuriya_figure2} | head -5
    expected_output_contains: "Connection"

  # ==========================================================================
  # VERBOSE OUTPUT MODE
  # ==========================================================================
  - name: Verbose output mode
    description: Run simulation with verbose output to stdout
    command: nftsim -i ${stimuli_only} -o test_output/stimuli-verbose.output -v 2>&1 | head -50
    expected_output_contains: "Time:"

  # ==========================================================================
  # TIMESTAMP OUTPUT
  # ==========================================================================
  - name: Timestamped output
    description: Run simulation with timestamped output filename
    command: nftsim -i ${stimuli_only} -t && ls test_output/*.output 2>/dev/null || ls *.output 2>/dev/null | head -1
    expected_exit_code: 0

  # ==========================================================================
  # OUTPUT VERIFICATION TESTS
  # ==========================================================================
  - name: Verify output header format
    description: Check that output file contains proper header with configuration echo
    command: head -20 test_output/eirs-corticothalamic.output
    depends_on: EIRS corticothalamic simulation
    expected_output_contains: "Connection matrix"

  - name: Verify output data section
    description: Check that output file contains data section separator
    command: grep -c "============" test_output/eirs-corticothalamic.output || echo "0"
    depends_on: EIRS corticothalamic simulation
    expected_output_contains: "1"

  - name: Verify output column headers
    description: Check that output contains column headers for time series
    command: grep "Time" test_output/eirs-corticothalamic.output | head -1
    depends_on: EIRS corticothalamic simulation
    expected_output_contains: "Time"

  - name: Verify numerical output
    description: Check that output contains numerical time series data
    command: tail -10 test_output/eirs-corticothalamic.output
    depends_on: EIRS corticothalamic simulation
    expected_output_contains: "e+"

  - name: Verify output file size
    description: Check that output file has reasonable size (not empty)
    command: test -s test_output/eirs-corticothalamic.output && echo "File has content" || echo "File is empty"
    depends_on: EIRS corticothalamic simulation
    expected_output_contains: "File has content"

  # ==========================================================================
  # PARAMETER VERIFICATION
  # ==========================================================================
  - name: Verify population parameters in output
    description: Check that output echoes population configuration
    command: grep "Population" test_output/eirs-corticothalamic.output | head -5
    depends_on: EIRS corticothalamic simulation
    expected_output_contains: "Population"

  - name: Verify propagator parameters in output
    description: Check that output echoes propagator configuration
    command: grep "Propagator" test_output/eirs-corticothalamic.output | head -5
    depends_on: EIRS corticothalamic simulation
    expected_output_contains: "Propagator"

  - name: Verify coupling parameters in output
    description: Check that output echoes coupling configuration
    command: grep "Coupling" test_output/eirs-corticothalamic.output | head -5
    depends_on: EIRS corticothalamic simulation
    expected_output_contains: "Coupling"

  # ==========================================================================
  # NODE CONFIGURATION TESTS
  # ==========================================================================
  - name: Verify node count in EIRS
    description: Check that EIRS simulation has correct node count (144)
    command: grep "Nodes:" test_output/eirs-corticothalamic.output | head -1
    depends_on: EIRS corticothalamic simulation
    expected_output_contains: "144"

  - name: Verify node count in E cortical
    description: Check that E cortical simulation has correct node count (900)
    command: grep "Nodes:" test_output/e-cortical.output | head -1
    depends_on: E cortical simulation
    expected_output_contains: "900"

  - name: Verify node count in EI cortical
    description: Check that EI cortical simulation has correct node count (2048)
    command: grep "Nodes:" test_output/ei-cortical.output | head -1
    depends_on: EI cortical simulation
    expected_output_contains: "2048"

  # ==========================================================================
  # TIME STEP VERIFICATION
  # ==========================================================================
  - name: Verify time step in EIRS
    description: Check that EIRS simulation has correct time step
    command: grep "Deltat:" test_output/eirs-corticothalamic.output | head -1
    depends_on: EIRS corticothalamic simulation
    expected_output_contains: "Deltat:"

  - name: Verify simulation duration in EIRS
    description: Check that EIRS simulation has correct duration (15 seconds)
    command: grep "Time:" test_output/eirs-corticothalamic.output | head -1
    depends_on: EIRS corticothalamic simulation
    expected_output_contains: "15"

  # ==========================================================================
  # FIRING FUNCTION VERIFICATION
  # ==========================================================================
  - name: Verify sigmoid firing function
    description: Check that output contains sigmoid firing function parameters
    command: grep "Sigmoid" test_output/eirs-corticothalamic.output | head -1
    depends_on: EIRS corticothalamic simulation
    expected_output_contains: "Sigmoid"

  - name: Verify firing parameters
    description: Check that output contains firing parameters (Theta, Sigma, Qmax)
    command: grep "Qmax" test_output/eirs-corticothalamic.output | head -1
    depends_on: EIRS corticothalamic simulation
    expected_output_contains: "Qmax"

  # ==========================================================================
  # STIMULUS CONFIGURATION VERIFICATION
  # ==========================================================================
  - name: Verify white noise stimulus
    description: Check that EIRS config uses white noise stimulus
    command: grep "White" test_output/eirs-corticothalamic.output | head -1
    depends_on: EIRS corticothalamic simulation
    expected_output_contains: "White"

  - name: Verify pulse stimulus in stimuli-only
    description: Check that stimuli-only config has pulse stimuli
    command: grep "Pulse" test_output/stimuli-only.output | head -2
    depends_on: Stimuli only simulation
    expected_output_contains: "Pulse"

  # ==========================================================================
  # WAVE PROPAGATOR VERIFICATION
  # ==========================================================================
  - name: Verify wave propagator
    description: Check that output contains wave propagator configuration
    command: grep "Wave" test_output/eirs-corticothalamic.output | head -1
    depends_on: EIRS corticothalamic simulation
    expected_output_contains: "Wave"

  - name: Verify map propagator
    description: Check that output contains map propagator configuration
    command: grep "Map" test_output/eirs-corticothalamic.output | head -1
    depends_on: EIRS corticothalamic simulation
    expected_output_contains: "Map"

  # ==========================================================================
  # DENDRITE CONFIGURATION VERIFICATION
  # ==========================================================================
  - name: Verify dendrite parameters
    description: Check that output contains dendrite alpha/beta parameters
    command: grep "Dendrite" test_output/eirs-corticothalamic.output | head -1
    depends_on: EIRS corticothalamic simulation
    expected_output_contains: "Dendrite"

  - name: Verify alpha parameter
    description: Check that dendrite has alpha parameter
    command: grep "alpha:" test_output/eirs-corticothalamic.output | head -1
    depends_on: EIRS corticothalamic simulation
    expected_output_contains: "alpha:"

  - name: Verify beta parameter
    description: Check that dendrite has beta parameter
    command: grep "beta:" test_output/eirs-corticothalamic.output | head -1
    depends_on: EIRS corticothalamic simulation
    expected_output_contains: "beta:"

  # ==========================================================================
  # ERROR HANDLING TESTS
  # ==========================================================================
  - name: Invalid config file handling
    description: Test behavior with non-existent config file
    command: nftsim -i /nonexistent/config.conf -o test_output/error.output 2>&1 || echo "Error handled"
    expected_output_contains: "Error"

  - name: Missing input flag value
    description: Test behavior with missing input file argument
    command: nftsim -i 2>&1 || echo "Error handled"
    expected_exit_code: 0

  # ==========================================================================
  # MULTIPLE SIMULATION RUNS
  # ==========================================================================
  - name: Sequential simulations
    description: Run multiple simulations sequentially to verify stability
    command: |
      nftsim -i ${stimuli_only} -o test_output/seq1.output && \
      nftsim -i ${stimuli_only} -o test_output/seq2.output && \
      nftsim -i ${stimuli_only} -o test_output/seq3.output && \
      echo "All sequential runs completed"
    expected_output_contains: "All sequential runs completed"

  - name: Verify sequential outputs are identical
    description: Check that repeated simulations produce identical results
    command: diff test_output/seq1.output test_output/seq2.output && echo "Outputs match"
    depends_on: Sequential simulations
    expected_output_contains: "Outputs match"

  # ==========================================================================
  # OUTPUT LINE COUNT VERIFICATION
  # ==========================================================================
  - name: Verify EIRS output line count
    description: Check that EIRS output has expected number of data lines
    command: wc -l < test_output/eirs-corticothalamic.output
    depends_on: EIRS corticothalamic simulation
    expected_exit_code: 0

  - name: Verify stimuli output line count
    description: Check that stimuli-only output has expected number of data lines
    command: wc -l < test_output/stimuli-only.output
    depends_on: Stimuli only simulation
    expected_exit_code: 0

  # ==========================================================================
  # COMPLETE WORKFLOW TEST
  # ==========================================================================
  - name: Complete EIRS workflow
    description: Full workflow test - run simulation and verify all expected outputs
    command: |
      rm -f test_output/workflow-test.output && \
      nftsim -i ${eirs_corticothalamic} -o test_output/workflow-test.output && \
      test -f test_output/workflow-test.output && \
      grep -q "Connection matrix" test_output/workflow-test.output && \
      grep -q "Population" test_output/workflow-test.output && \
      grep -q "Time" test_output/workflow-test.output && \
      echo "Complete workflow successful"
    expected_output_contains: "Complete workflow successful"

cleanup:
  script: |
    #!/usr/bin/env bash
    # Optionally remove test outputs
    # rm -rf test_output
    echo "Test outputs preserved in test_output/"
