# heudiconv container test suite
# Tests for heudiconv v1.3.1 - flexible DICOM converter for organizing brain imaging data
#
# This container includes:
#   - heudiconv: DICOM to BIDS converter
#   - dcm2niix: DICOM to NIfTI converter
#   - nibabel utilities: nib-ls, nib-diff, nib-stats, nib-roi, nib-conform, nib-convert, nib-nifti-dx
#   - dcmstack: DICOM stacking utility
#   - pydicom: DICOM file inspection
#
# Test data: ds000001/sub-01 (OpenNeuro Balloon Analog Risk-taking Task)
#   - T1w: 160x192x192, 1.00x1.33x1.33mm (3D structural)
#   - inplaneT2: inplane T2 weighted scan
#   - BOLD: 64x64x33x300, 3.12x3.12x4.00mm, TR=2s (4D functional)

name: heudiconv
version: 1.3.1
container: heudiconv_1.3.1_20241105.simg

required_files:
  - dataset: ds000001
    files:
      - sub-01/anat/sub-01_T1w.nii.gz
      - sub-01/anat/sub-01_inplaneT2.nii.gz
      - sub-01/func/sub-01_task-balloonanalogrisktask_run-01_bold.nii.gz

test_data:
  t1w: ds000001/sub-01/anat/sub-01_T1w.nii.gz
  t2: ds000001/sub-01/anat/sub-01_inplaneT2.nii.gz
  bold: ds000001/sub-01/func/sub-01_task-balloonanalogrisktask_run-01_bold.nii.gz
  output_dir: test_output

setup:
  script: |
    #!/usr/bin/env bash
    set -e
    mkdir -p test_output
    mkdir -p test_output/heudiconv_out
    mkdir -p test_output/dcm2niix_out
    mkdir -p test_output/nibabel_out

tests:
  # ==========================================================================
  # HEUDICONV - VERSION AND HELP
  # ==========================================================================
  - name: Heudiconv version check
    description: Verify heudiconv binary runs and reports version
    command: heudiconv --version
    expected_output_contains: "1.3.1"

  - name: Heudiconv help
    description: Display heudiconv help message
    command: heudiconv --help 2>&1 | head -20
    expected_output_contains: "DICOM"

  # ==========================================================================
  # HEUDICONV - BUILT-IN HEURISTICS
  # ==========================================================================
  - name: List built-in heuristics
    description: List all available built-in heuristics
    command: heudiconv --command heuristics 2>&1
    expected_output_contains: "reproin"

  - name: Get heuristic info - convertall
    description: Get detailed information about the convertall heuristic
    command: heudiconv --command heuristic-info -f convertall 2>&1
    expected_output_contains: "heudiconv"

  - name: Get heuristic info - reproin
    description: Get detailed information about the reproin heuristic
    command: heudiconv --command heuristic-info -f reproin 2>&1
    expected_output_contains: "Flexible heuristic"

  - name: Get heuristic info - bids_ME
    description: Get information about multi-echo BIDS heuristic
    command: heudiconv --command heuristic-info -f bids_ME 2>&1
    expected_output_contains: "Multi-Echo"

  # ==========================================================================
  # DCM2NIIX - VERSION AND HELP
  # ==========================================================================
  - name: dcm2niix version check
    description: Verify dcm2niix binary runs and reports version
    command: dcm2niix --version 2>&1
    ignore_exit_code: true
    expected_output_contains: "v1.0.20220720"

  - name: dcm2niix help
    description: Display dcm2niix help message
    command: dcm2niix -h 2>&1 | head -20
    expected_output_contains: "dcm2niix"

  # ==========================================================================
  # NIBABEL - nib-ls (NIfTI listing)
  # ==========================================================================
  - name: nib-ls version check
    description: Verify nib-ls binary runs
    command: nib-ls --version 2>&1
    expected_exit_code: 0

  - name: nib-ls T1w basic info
    description: List basic information for T1w image
    command: nib-ls ${t1w}
    expected_output_contains: "160"

  - name: nib-ls T1w with stats
    description: List T1w image with basic statistics
    command: nib-ls -s ${t1w}
    expected_output_contains: "160"

  - name: nib-ls BOLD basic info
    description: List basic information for BOLD image
    command: nib-ls ${bold}
    expected_output_contains: "64"

  - name: nib-ls BOLD with stats
    description: List BOLD image with basic statistics
    command: nib-ls -s ${bold}
    expected_output_contains: "300"

  - name: nib-ls multiple files
    description: List information for multiple NIfTI files
    command: nib-ls ${t1w} ${t2} ${bold}
    expected_output_contains: "T1w"

  - name: nib-ls header fields
    description: List specific header fields
    command: nib-ls -H "dim,pixdim" ${t1w}
    expected_output_contains: "1.333333"

  - name: nib-ls verbose output
    description: List image with verbose output
    command: nib-ls -v ${t1w}
    expected_output_contains: "160"

  # ==========================================================================
  # NIBABEL - nib-diff (NIfTI comparison)
  # ==========================================================================
  - name: nib-diff identical files
    description: Compare identical NIfTI files (should show no differences)
    command: nib-diff ${t1w} ${t1w} 2>&1
    expected_exit_code: 0

  - name: nib-diff different files
    description: Compare different NIfTI files (exit 1 = files differ)
    command: nib-diff ${t1w} ${t2} 2>&1
    ignore_exit_code: true
    expected_output_contains: "dim"

  - name: nib-diff with header fields
    description: Compare files showing specific header fields (exit 1 = files differ)
    command: nib-diff -H "pixdim" ${t1w} ${t2} 2>&1
    ignore_exit_code: true
    expected_output_contains: "pixdim"

  - name: nib-diff verbose
    description: Compare files with verbose output (exit 1 = files differ)
    command: nib-diff -v ${t1w} ${t2} 2>&1
    ignore_exit_code: true
    expected_output_contains: "dim"

  # ==========================================================================
  # NIBABEL - nib-stats (NIfTI statistics)
  # ==========================================================================
  - name: nib-stats T1w volume
    description: Calculate mask volume of T1w image
    command: nib-stats -V ${t1w}
    expected_output_contains: "."

  - name: nib-stats T1w volume in mm3
    description: Calculate mask volume in cubic millimeters
    command: nib-stats -V --units mm3 ${t1w}
    expected_output_contains: "."

  - name: nib-stats T1w volume in voxels
    description: Calculate mask volume in voxels
    command: nib-stats -V --units vox ${t1w}
    expected_exit_code: 0

  - name: nib-stats BOLD volume
    description: Calculate mask volume of BOLD image
    command: nib-stats -V ${bold}
    expected_output_contains: "."

  # ==========================================================================
  # NIBABEL - nib-nifti-dx (NIfTI diagnostics)
  # ==========================================================================
  - name: nib-nifti-dx T1w
    description: Print NIfTI diagnostics for T1w image
    command: nib-nifti-dx ${t1w}
    expected_output_contains: "clean"

  - name: nib-nifti-dx BOLD
    description: Print NIfTI diagnostics for BOLD image
    command: nib-nifti-dx ${bold}
    expected_output_contains: "clean"

  - name: nib-nifti-dx T2
    description: Print NIfTI diagnostics for T2 image
    command: nib-nifti-dx ${t2}
    expected_output_contains: "clean"

  - name: nib-nifti-dx multiple files
    description: Print NIfTI diagnostics for multiple files
    command: nib-nifti-dx ${t1w} ${t2} ${bold}
    expected_output_contains: "clean"

  - name: nib-nifti-dx NIfTI1 mode
    description: Check diagnostics in NIfTI1 mode
    command: nib-nifti-dx -1 ${t1w}
    expected_output_contains: "clean"

  # ==========================================================================
  # NIBABEL - nib-roi (Region of Interest extraction)
  # ==========================================================================
  - name: nib-roi extract central cube
    description: Extract a central region from T1w image
    command: nib-roi -i 40:120 -j 50:140 -k 50:140 ${t1w} test_output/nibabel_out/t1w_roi_central.nii.gz
    validate:
      - output_exists: ${output_dir}/nibabel_out/t1w_roi_central.nii.gz

  - name: nib-roi verify extracted dimensions
    description: Verify the dimensions of extracted ROI
    command: |
      nib-roi -i 40:120 -j 50:140 -k 50:140 ${t1w} test_output/nibabel_out/t1w_roi_central.nii.gz && \
      nib-ls test_output/nibabel_out/t1w_roi_central.nii.gz
    expected_output_contains: "80"

  - name: nib-roi extract single slice
    description: Extract a single slice along k dimension
    command: nib-roi -k 96:97 ${t1w} test_output/nibabel_out/t1w_single_slice.nii.gz
    validate:
      - output_exists: ${output_dir}/nibabel_out/t1w_single_slice.nii.gz

  - name: nib-roi extract temporal subset
    description: Extract first 10 timepoints from BOLD
    command: nib-roi -t 0:10 ${bold} test_output/nibabel_out/bold_first10.nii.gz
    validate:
      - output_exists: ${output_dir}/nibabel_out/bold_first10.nii.gz

  - name: nib-roi verify temporal subset
    description: Verify BOLD temporal subset has 10 volumes
    command: nib-ls test_output/nibabel_out/bold_first10.nii.gz
    depends_on: nib-roi extract temporal subset
    expected_output_contains: "10"

  - name: nib-roi extract last timepoints
    description: Extract last 20 timepoints from BOLD
    command: nib-roi -t 280:300 ${bold} test_output/nibabel_out/bold_last20.nii.gz
    validate:
      - output_exists: ${output_dir}/nibabel_out/bold_last20.nii.gz

  - name: nib-roi flip i axis
    description: Extract ROI with flipped i axis
    command: nib-roi -i 160:0:-1 ${t1w} test_output/nibabel_out/t1w_flip_i.nii.gz
    validate:
      - output_exists: ${output_dir}/nibabel_out/t1w_flip_i.nii.gz

  - name: nib-roi spatial and temporal crop
    description: Extract spatial and temporal subset from BOLD
    command: nib-roi -i 10:50 -j 10:50 -k 5:28 -t 10:20 ${bold} test_output/nibabel_out/bold_cropped.nii.gz
    validate:
      - output_exists: ${output_dir}/nibabel_out/bold_cropped.nii.gz

  # ==========================================================================
  # NIBABEL - nib-conform (Image conforming)
  # ==========================================================================
  - name: nib-conform default
    description: Conform T1w to default shape and voxel size
    command: nib-conform ${t1w} test_output/nibabel_out/t1w_conformed.nii.gz -f
    validate:
      - output_exists: ${output_dir}/nibabel_out/t1w_conformed.nii.gz

  - name: nib-conform custom shape
    description: Conform T1w to custom shape (128x128x128)
    command: nib-conform --out-shape 128 128 128 ${t1w} test_output/nibabel_out/t1w_128cube.nii.gz -f
    validate:
      - output_exists: ${output_dir}/nibabel_out/t1w_128cube.nii.gz

  - name: nib-conform verify custom shape
    description: Verify conformed image has correct dimensions
    command: nib-ls test_output/nibabel_out/t1w_128cube.nii.gz
    depends_on: nib-conform custom shape
    expected_output_contains: "128"

  - name: nib-conform custom voxel size
    description: Conform T1w to 2mm isotropic voxels
    command: nib-conform --voxel-size 2 2 2 ${t1w} test_output/nibabel_out/t1w_2mm.nii.gz -f
    validate:
      - output_exists: ${output_dir}/nibabel_out/t1w_2mm.nii.gz

  - name: nib-conform RAS orientation
    description: Conform T1w to RAS orientation
    command: nib-conform --orientation RAS ${t1w} test_output/nibabel_out/t1w_ras.nii.gz -f
    validate:
      - output_exists: ${output_dir}/nibabel_out/t1w_ras.nii.gz

  - name: nib-conform LPI orientation
    description: Conform T1w to LPI orientation
    command: nib-conform --orientation LPI ${t1w} test_output/nibabel_out/t1w_lpi.nii.gz -f
    validate:
      - output_exists: ${output_dir}/nibabel_out/t1w_lpi.nii.gz

  - name: nib-conform custom shape and voxel size
    description: Conform T1w to custom shape and voxel size
    command: nib-conform --out-shape 96 96 96 --voxel-size 2 2 2 ${t1w} test_output/nibabel_out/t1w_custom.nii.gz -f
    validate:
      - output_exists: ${output_dir}/nibabel_out/t1w_custom.nii.gz

  - name: nib-conform T2 image
    description: Conform T2 image to default parameters
    command: nib-conform ${t2} test_output/nibabel_out/t2_conformed.nii.gz -f
    validate:
      - output_exists: ${output_dir}/nibabel_out/t2_conformed.nii.gz

  # ==========================================================================
  # NIBABEL - nib-convert (Image format conversion)
  # ==========================================================================
  - name: nib-convert to float32
    description: Convert T1w to float32 data type
    command: nib-convert --out-dtype float32 ${t1w} test_output/nibabel_out/t1w_float32.nii.gz -f
    validate:
      - output_exists: ${output_dir}/nibabel_out/t1w_float32.nii.gz

  - name: nib-convert to uint8
    description: Convert T1w to uint8 data type
    command: nib-convert --out-dtype uint8 ${t1w} test_output/nibabel_out/t1w_uint8.nii.gz -f
    validate:
      - output_exists: ${output_dir}/nibabel_out/t1w_uint8.nii.gz

  - name: nib-convert to int32
    description: Convert T1w to int32 data type
    command: nib-convert --out-dtype int32 ${t1w} test_output/nibabel_out/t1w_int32.nii.gz -f
    validate:
      - output_exists: ${output_dir}/nibabel_out/t1w_int32.nii.gz

  - name: nib-convert to float64
    description: Convert T1w to float64 data type
    command: nib-convert --out-dtype float64 ${t1w} test_output/nibabel_out/t1w_float64.nii.gz -f
    validate:
      - output_exists: ${output_dir}/nibabel_out/t1w_float64.nii.gz

  - name: nib-convert BOLD to float32
    description: Convert BOLD to float32 data type
    command: nib-convert --out-dtype float32 ${bold} test_output/nibabel_out/bold_float32.nii.gz -f
    validate:
      - output_exists: ${output_dir}/nibabel_out/bold_float32.nii.gz

  - name: nib-convert to uncompressed nii
    description: Convert T1w to uncompressed NIfTI format
    command: nib-convert ${t1w} test_output/nibabel_out/t1w_uncompressed.nii -f
    validate:
      - output_exists: ${output_dir}/nibabel_out/t1w_uncompressed.nii

  # ==========================================================================
  # PYDICOM - DICOM utilities
  # ==========================================================================
  - name: pydicom help
    description: Display pydicom help message
    command: pydicom --help
    expected_output_contains: "pydicom"

  - name: pydicom show help
    description: Display pydicom show subcommand help
    command: pydicom show --help
    expected_output_contains: "DICOM"

  - name: pydicom help subcommand
    description: Display help for specific pydicom subcommand
    command: pydicom help show
    expected_output_contains: "show"

  # ==========================================================================
  # DCMSTACK - DICOM stacking utility
  # ==========================================================================
  - name: dcmstack version
    description: Display dcmstack version
    command: dcmstack --version 2>&1
    expected_exit_code: 0

  - name: dcmstack help
    description: Display dcmstack help message
    command: dcmstack --help
    expected_output_contains: "DICOM"

  - name: dcmstack list translators
    description: List available DICOM translators
    command: dcmstack --list-translators 2>&1
    expected_output_contains: "Csa"

  - name: dcmstack default regexes
    description: Show default include/exclude regular expressions
    command: dcmstack --default-regexes 2>&1
    expected_output_contains: "regular expressions"

  # ==========================================================================
  # HEUDICONV - PIPELINE TESTING (dry run modes)
  # ==========================================================================
  - name: Heudiconv populate templates
    description: Test populate-templates command functionality
    command: heudiconv --command populate-templates 2>&1 || true
    expected_exit_code: 0

  # ==========================================================================
  # COMBINED WORKFLOWS
  # ==========================================================================
  - name: Multi-file NIfTI inspection
    description: Comprehensive inspection of multiple NIfTI files
    command: |
      echo "=== T1w ===" && nib-ls -s ${t1w} && \
      echo "=== T2 ===" && nib-ls -s ${t2} && \
      echo "=== BOLD ===" && nib-ls -s ${bold}
    expected_output_contains: "T1w"

  - name: File comparison workflow
    description: Compare structural images
    command: nib-diff -v ${t1w} ${t2} 2>&1 | head -20
    expected_output_contains: "dim"

  - name: ROI extraction and verification
    description: Extract ROI and verify its properties
    command: |
      nib-roi -i 50:110 -j 60:130 -k 60:130 ${t1w} test_output/nibabel_out/t1w_brain_roi.nii.gz && \
      nib-ls -s test_output/nibabel_out/t1w_brain_roi.nii.gz && \
      nib-nifti-dx test_output/nibabel_out/t1w_brain_roi.nii.gz
    validate:
      - output_exists: ${output_dir}/nibabel_out/t1w_brain_roi.nii.gz

  - name: Image reorientation pipeline
    description: Conform image and verify orientation
    command: |
      nib-conform --orientation RAS ${t1w} test_output/nibabel_out/t1w_ras_pipe.nii.gz -f && \
      nib-ls test_output/nibabel_out/t1w_ras_pipe.nii.gz && \
      nib-nifti-dx test_output/nibabel_out/t1w_ras_pipe.nii.gz
    validate:
      - output_exists: ${output_dir}/nibabel_out/t1w_ras_pipe.nii.gz

  - name: BOLD preprocessing ROI workflow
    description: Extract temporal and spatial subset from BOLD data
    command: |
      nib-roi -t 50:100 ${bold} test_output/nibabel_out/bold_subset.nii.gz && \
      nib-ls -s test_output/nibabel_out/bold_subset.nii.gz
    validate:
      - output_exists: ${output_dir}/nibabel_out/bold_subset.nii.gz

  - name: Format conversion pipeline
    description: Convert and verify data type changes
    command: |
      nib-convert --out-dtype float32 ${t1w} test_output/nibabel_out/t1w_f32_pipe.nii.gz -f && \
      nib-ls test_output/nibabel_out/t1w_f32_pipe.nii.gz
    validate:
      - output_exists: ${output_dir}/nibabel_out/t1w_f32_pipe.nii.gz
    expected_output_contains: "float32"

  - name: Isotropic resampling pipeline
    description: Conform image to 1mm isotropic voxels
    command: |
      nib-conform --voxel-size 1 1 1 ${t1w} test_output/nibabel_out/t1w_1mm_iso.nii.gz -f && \
      nib-ls test_output/nibabel_out/t1w_1mm_iso.nii.gz
    validate:
      - output_exists: ${output_dir}/nibabel_out/t1w_1mm_iso.nii.gz
    expected_output_contains: "1.00x1.00x1.00"

  # ==========================================================================
  # DIAGNOSTICS AND VALIDATION
  # ==========================================================================
  - name: Validate all test outputs
    description: Run NIfTI diagnostics on all generated outputs
    command: |
      for f in test_output/nibabel_out/*.nii.gz test_output/nibabel_out/*.nii; do
        if [ -f "$f" ]; then
          echo "Checking: $f"
          nib-nifti-dx "$f" 2>&1 || echo "Warning: $f may have issues"
        fi
      done
    expected_output_contains: "Checking"

  - name: List all generated outputs
    description: List all files generated by tests
    command: ls -la test_output/nibabel_out/
    expected_output_contains: "nii"

cleanup:
  script: |
    #!/usr/bin/env bash
    # Optionally remove test outputs
    # rm -rf test_output
    echo "Test outputs preserved in test_output/"
