# TrackVis container test suite
# Tests for TrackVis v0.6.1 - Fiber tracking visualization toolkit
#
# TrackVis (track_vis) is a command-line tool for visualizing and filtering
# fiber tracks from diffusion MRI tractography. It works with .trk track files
# generated by Diffusion Toolkit or similar tools.
#
# IMPORTANT: TrackVis requires a free license from http://www.trackvis.org/download/
# The license must be entered on first startup.
#
# Test data: ds000001/sub-01 (OpenNeuro Balloon Analog Risk-taking Task)
#   - T1w: 160x192x192, 1x1.33x1.33mm (3D structural, used as ROI reference)
#   - Note: This dataset does not contain diffusion MRI data or .trk files
#   - A synthetic track file is created in setup for testing purposes
#
# Citation: Ruopeng Wang, Van J. Wedeen, TrackVis.org, Martinos Center for
# Biomedical Imaging, Massachusetts General Hospital
# Proc. Intl. Soc. Mag. Reson. Med. 15 (2007) 3720

name: trackvis
version: 0.6.1
container: trackvis_0.6.1_20220303.simg

binaries:
  track_vis: /opt/trackvis-0.6.1/track_vis
  trackvis_gui: /opt/trackvis-0.6.1/trackvis

required_files:
  - dataset: ds000001
    files:
      - sub-01/anat/sub-01_T1w.nii.gz
      - sub-01/anat/sub-01_inplaneT2.nii.gz

test_data:
  t1w: ds000001/sub-01/anat/sub-01_T1w.nii.gz
  t2: ds000001/sub-01/anat/sub-01_inplaneT2.nii.gz
  output_dir: test_output

setup:
  host_script: |
    #!/usr/bin/env bash
    set -e
    mkdir -p test_output

    # Create a minimal synthetic track file for testing
    # The .trk file format has a 1000-byte header followed by track data
    # This creates a minimal valid track file with one simple track

    python3 << 'PYTHON_SCRIPT'
    import struct
    import numpy as np

    # Create minimal .trk file
    # Header is 1000 bytes
    header = bytearray(1000)

    # Magic number "TRACK" at offset 0
    header[0:5] = b'TRACK'

    # Dimensions (int16 at offset 6-11) - match T1w roughly
    dims = struct.pack('<3h', 160, 192, 192)
    header[6:12] = dims

    # Voxel size (float32 at offset 12-23)
    voxel_size = struct.pack('<3f', 1.0, 1.33, 1.33)
    header[12:24] = voxel_size

    # Origin (float32 at offset 24-35)
    origin = struct.pack('<3f', 0.0, 0.0, 0.0)
    header[24:36] = origin

    # Number of scalars per point (int16 at offset 36-37)
    n_scalars = struct.pack('<h', 0)
    header[36:38] = n_scalars

    # Number of properties per track (int16 at offset 238-239)
    n_properties = struct.pack('<h', 0)
    header[238:240] = n_properties

    # Voxel order (char[4] at offset 948-951) - RAS
    header[948:952] = b'RAS\x00'

    # Voxel order is valid (char at offset 952)
    header[952] = 1

    # Image orientation patient (float32[6] at offset 956-979)
    # Standard RAS orientation
    img_orient = struct.pack('<6f', 1.0, 0.0, 0.0, 0.0, 1.0, 0.0)
    header[956:980] = img_orient

    # Version (int32 at offset 992-995) - version 2
    version = struct.pack('<i', 2)
    header[992:996] = version

    # Header size (int32 at offset 996-999)
    hdr_size = struct.pack('<i', 1000)
    header[996:1000] = hdr_size

    # Number of tracks (int32 at offset 988-991)
    # We'll write 10 tracks
    n_tracks = struct.pack('<i', 10)
    header[988:992] = n_tracks

    # Write the file
    with open('test_output/synthetic_tracks.trk', 'wb') as f:
        f.write(header)

        # Write 10 simple tracks
        for i in range(10):
            # Each track: number of points (int32) + points (float32 x 3 per point)
            n_points = 20  # 20 points per track
            f.write(struct.pack('<i', n_points))

            # Generate a simple curved track
            for j in range(n_points):
                # Create a slightly curved line in 3D space
                x = 80.0 + i * 5.0 + j * 2.0
                y = 96.0 + np.sin(j * 0.3) * 10.0
                z = 96.0 + i * 3.0 + j * 1.5
                f.write(struct.pack('<3f', x, y, z))

    print("Created synthetic track file: test_output/synthetic_tracks.trk")

    # Create a second track file with more tracks for merging tests
    with open('test_output/synthetic_tracks2.trk', 'wb') as f:
        header_copy = bytearray(header)
        n_tracks2 = struct.pack('<i', 5)
        header_copy[988:992] = n_tracks2
        f.write(header_copy)

        for i in range(5):
            n_points = 15
            f.write(struct.pack('<i', n_points))
            for j in range(n_points):
                x = 70.0 + i * 3.0 + j * 1.5
                y = 100.0 + np.cos(j * 0.4) * 8.0
                z = 80.0 + i * 4.0 + j * 2.0
                f.write(struct.pack('<3f', x, y, z))

    print("Created second synthetic track file: test_output/synthetic_tracks2.trk")
    PYTHON_SCRIPT

    # Create a simple binary mask from T1w for ROI testing
    # Using singularity to create mask with simple thresholding

tests:
  # ==========================================================================
  # BASIC FUNCTIONALITY
  # ==========================================================================
  - name: Version check
    description: Verify track_vis binary runs and reports version
    command: /opt/trackvis-0.6.1/track_vis --version
    expected_output_contains: "track_vis"

  - name: Help display
    description: Display full help/usage information
    command: /opt/trackvis-0.6.1/track_vis --help 2>&1 | head -50
    expected_output_contains: "Usage:"

  - name: Help filtering options
    description: Check filtering options are documented
    command: /opt/trackvis-0.6.1/track_vis --help 2>&1 | grep -A2 "length_threshold"
    expected_output_contains: "length"

  - name: Help output options
    description: Check output options are documented
    command: /opt/trackvis-0.6.1/track_vis --help 2>&1 | grep -A2 "\-\-output"
    expected_output_contains: "output"

  # ==========================================================================
  # TRACK FILE LOADING AND BASIC DISPLAY (no-render mode)
  # ==========================================================================
  - name: Load track file (no render)
    description: Load synthetic track file without rendering
    command: /opt/trackvis-0.6.1/track_vis test_output/synthetic_tracks.trk -nr 2>&1
    expected_exit_code: 0

  - name: Display track count
    description: Load tracks and report statistics (disabled log)
    command: /opt/trackvis-0.6.1/track_vis test_output/synthetic_tracks.trk -nr -disable_log 2>&1
    expected_exit_code: 0

  # ==========================================================================
  # LENGTH FILTERING
  # ==========================================================================
  - name: Length threshold (minimum only)
    description: Filter tracks by minimum length
    command: /opt/trackvis-0.6.1/track_vis test_output/synthetic_tracks.trk -l 10 1000 -nr -disable_log 2>&1
    expected_exit_code: 0

  - name: Length threshold (range)
    description: Filter tracks within length range 20-100mm
    command: /opt/trackvis-0.6.1/track_vis test_output/synthetic_tracks.trk -l 20 100 -nr -disable_log 2>&1
    expected_exit_code: 0

  - name: Length threshold output
    description: Filter by length and save filtered tracks
    command: /opt/trackvis-0.6.1/track_vis test_output/synthetic_tracks.trk -l 10 500 -o test_output/tracks_length_filtered.trk -nr -disable_log 2>&1
    validate:
      - output_exists: ${output_dir}/tracks_length_filtered.trk

  # ==========================================================================
  # SLICE FILTERING
  # ==========================================================================
  - name: Sagittal slice filter
    description: Filter tracks crossing sagittal slice 80
    command: /opt/trackvis-0.6.1/track_vis test_output/synthetic_tracks.trk -nx 80 -nr -disable_log 2>&1
    expected_exit_code: 0

  - name: Coronal slice filter
    description: Filter tracks crossing coronal slice 96
    command: /opt/trackvis-0.6.1/track_vis test_output/synthetic_tracks.trk -ny 96 -nr -disable_log 2>&1
    expected_exit_code: 0

  - name: Axial slice filter
    description: Filter tracks crossing axial slice 96
    command: /opt/trackvis-0.6.1/track_vis test_output/synthetic_tracks.trk -nz 96 -nr -disable_log 2>&1
    expected_exit_code: 0

  - name: Slab filter (multiple slices)
    description: Filter tracks crossing sagittal slab 70-90
    command: /opt/trackvis-0.6.1/track_vis test_output/synthetic_tracks.trk -nx 70 90 -nr -disable_log 2>&1
    expected_exit_code: 0

  - name: Sagittal slice exclusion
    description: Exclude tracks crossing sagittal slice 100
    command: /opt/trackvis-0.6.1/track_vis test_output/synthetic_tracks.trk -mx 100 -nr -disable_log 2>&1
    expected_exit_code: 0

  - name: End point sagittal filter
    description: Filter tracks ending in sagittal slice range
    command: /opt/trackvis-0.6.1/track_vis test_output/synthetic_tracks.trk -ex 80 120 -nr -disable_log 2>&1
    expected_exit_code: 0

  # ==========================================================================
  # U-FACTOR AND CURVATURE FILTERING
  # ==========================================================================
  - name: U-factor threshold
    description: Filter by U-factor (U-shapeness measure)
    command: /opt/trackvis-0.6.1/track_vis test_output/synthetic_tracks.trk -u -0.5 0.5 -nr -disable_log 2>&1
    expected_exit_code: 0

  - name: Curvature threshold
    description: Filter tracks by curvature range
    command: /opt/trackvis-0.6.1/track_vis test_output/synthetic_tracks.trk -curvature 0 0.5 -nr -disable_log 2>&1
    expected_exit_code: 0

  - name: Torsion threshold
    description: Filter tracks by torsion range
    command: /opt/trackvis-0.6.1/track_vis test_output/synthetic_tracks.trk -torsion -1 1 -nr -disable_log 2>&1
    expected_exit_code: 0

  # ==========================================================================
  # SKIP/SUBSAMPLING
  # ==========================================================================
  - name: Skip tracks
    description: Display every 2nd track only
    command: /opt/trackvis-0.6.1/track_vis test_output/synthetic_tracks.trk -skip 2 -nr -disable_log 2>&1
    expected_exit_code: 0

  - name: Proportional skip
    description: Skip tracks proportionally based on length
    command: /opt/trackvis-0.6.1/track_vis test_output/synthetic_tracks.trk -skipp 2 1 -nr -disable_log 2>&1
    expected_exit_code: 0

  # ==========================================================================
  # TRACK EXTENSION
  # ==========================================================================
  - name: Extend tracks
    description: Extend track endpoints by 5mm before filtering
    command: /opt/trackvis-0.6.1/track_vis test_output/synthetic_tracks.trk -ext 5 -nr -disable_log 2>&1
    expected_exit_code: 0

  # ==========================================================================
  # ROI POINTER FILTERING
  # ==========================================================================
  - name: ROI pointer (single voxel)
    description: Filter tracks passing through voxel ROI at (80,96,96) radius 5
    command: /opt/trackvis-0.6.1/track_vis test_output/synthetic_tracks.trk -roi_pt 80 96 96 5 1 -nr -disable_log 2>&1
    expected_exit_code: 0

  - name: Dual ROI pointers
    description: Filter tracks passing through two ROI points
    command: /opt/trackvis-0.6.1/track_vis test_output/synthetic_tracks.trk -roi_pt 80 96 96 5 1 -roi_pt2 100 96 110 5 1 -nr -disable_log 2>&1
    expected_exit_code: 0

  - name: ROI disk filter
    description: Filter tracks passing through a disk ROI
    command: /opt/trackvis-0.6.1/track_vis test_output/synthetic_tracks.trk -roi_disk 80 96 96 10 1 0 0 0 90 1 -nr -disable_log 2>&1
    expected_exit_code: 0

  # ==========================================================================
  # OUTPUT OPTIONS
  # ==========================================================================
  - name: Output filtered tracks
    description: Save filtered tracks to new file
    command: /opt/trackvis-0.6.1/track_vis test_output/synthetic_tracks.trk -l 5 1000 -o test_output/tracks_filtered.trk -nr -disable_log 2>&1
    validate:
      - output_exists: ${output_dir}/tracks_filtered.trk

  - name: Output track volume
    description: Convert tracks to volume image (NIfTI)
    command: /opt/trackvis-0.6.1/track_vis test_output/synthetic_tracks.trk -ov test_output/tracks_volume.nii.gz -nr -disable_log 2>&1
    validate:
      - output_exists: ${output_dir}/tracks_volume.nii.gz

  - name: Output endpoint volume
    description: Convert track endpoints only to volume
    command: /opt/trackvis-0.6.1/track_vis test_output/synthetic_tracks.trk -ov test_output/tracks_endpoints.nii.gz 1 -nr -disable_log 2>&1
    validate:
      - output_exists: ${output_dir}/tracks_endpoints.nii.gz

  # ==========================================================================
  # CAMERA OPERATIONS (for screen capture/batch processing)
  # ==========================================================================
  - name: Save camera position
    description: Test save_cam option is accepted (file not created with -nr since no camera initialized)
    command: /opt/trackvis-0.6.1/track_vis test_output/synthetic_tracks.trk -save_cam test_output/camera.cam -nr -disable_log 2>&1
    expected_output_contains: "Number of tracks"

  - name: Camera azimuth rotation
    description: Apply camera rotation (no display)
    command: /opt/trackvis-0.6.1/track_vis test_output/synthetic_tracks.trk -camera azimuth 45 -nr -disable_log 2>&1
    expected_exit_code: 0

  - name: Camera elevation rotation
    description: Apply camera elevation (no display)
    command: /opt/trackvis-0.6.1/track_vis test_output/synthetic_tracks.trk -camera elevation 30 -nr -disable_log 2>&1
    expected_exit_code: 0

  - name: Camera dolly (zoom)
    description: Apply camera dolly/zoom
    command: /opt/trackvis-0.6.1/track_vis test_output/synthetic_tracks.trk -camera dolly 1.5 -nr -disable_log 2>&1
    expected_exit_code: 0

  - name: Camera offset
    description: Set focal point offset
    command: /opt/trackvis-0.6.1/track_vis test_output/synthetic_tracks.trk -offset 10 10 10 -nr -disable_log 2>&1
    expected_exit_code: 0

  # ==========================================================================
  # DISPLAY OPTIONS (tested in no-render mode for validation)
  # ==========================================================================
  - name: Solid color option
    description: Set solid color for tracks (red)
    command: /opt/trackvis-0.6.1/track_vis test_output/synthetic_tracks.trk -c 1 0 0 -nr -disable_log 2>&1
    expected_exit_code: 0

  - name: Directional color coding
    description: Enable direction-coded coloring
    command: /opt/trackvis-0.6.1/track_vis test_output/synthetic_tracks.trk -dc -nr -disable_log 2>&1
    expected_exit_code: 0

  - name: Transparent display
    description: Enable transparent track display
    command: /opt/trackvis-0.6.1/track_vis test_output/synthetic_tracks.trk -t -nr -disable_log 2>&1
    expected_exit_code: 0

  - name: Shading option
    description: Enable shaded tube display
    command: /opt/trackvis-0.6.1/track_vis test_output/synthetic_tracks.trk -s -nr -disable_log 2>&1
    expected_exit_code: 0

  - name: Wireframe option
    description: Enable wireframe tube display
    command: /opt/trackvis-0.6.1/track_vis test_output/synthetic_tracks.trk -wf -nr -disable_log 2>&1
    expected_exit_code: 0

  - name: Tube radius
    description: Set tube radius for shaded display
    command: /opt/trackvis-0.6.1/track_vis test_output/synthetic_tracks.trk -s -r 0.1 -nr -disable_log 2>&1
    expected_exit_code: 0

  - name: Number of sides
    description: Set number of sides for tubes
    command: /opt/trackvis-0.6.1/track_vis test_output/synthetic_tracks.trk -s -ns 8 -nr -disable_log 2>&1
    expected_exit_code: 0

  - name: Frame box display
    description: Enable frame box with axes
    command: /opt/trackvis-0.6.1/track_vis test_output/synthetic_tracks.trk -box -nr -disable_log 2>&1
    expected_exit_code: 0

  - name: Background color
    description: Set background color (white)
    command: /opt/trackvis-0.6.1/track_vis test_output/synthetic_tracks.trk -bc 1 1 1 -nr -disable_log 2>&1
    expected_exit_code: 0

  - name: Window size
    description: Set display window size
    command: /opt/trackvis-0.6.1/track_vis test_output/synthetic_tracks.trk -ws 800 600 -nr -disable_log 2>&1
    expected_exit_code: 0

  - name: Anti-aliasing
    description: Enable anti-aliasing render
    command: /opt/trackvis-0.6.1/track_vis test_output/synthetic_tracks.trk -aa -nr -disable_log 2>&1
    expected_exit_code: 0

  - name: Title overlay
    description: Set title text overlay
    command: /opt/trackvis-0.6.1/track_vis test_output/synthetic_tracks.trk -title "Test Title" -nr -disable_log 2>&1
    expected_exit_code: 0

  - name: No annotation
    description: Disable annotation display
    command: /opt/trackvis-0.6.1/track_vis test_output/synthetic_tracks.trk -na -nr -disable_log 2>&1
    expected_exit_code: 0

  - name: Ball marker
    description: Display ball marker at position
    command: /opt/trackvis-0.6.1/track_vis test_output/synthetic_tracks.trk -ball 80 96 96 5 -nr -disable_log 2>&1
    expected_exit_code: 0

  - name: Circle display
    description: Display circle with each track
    command: /opt/trackvis-0.6.1/track_vis test_output/synthetic_tracks.trk -circle -nr -disable_log 2>&1
    expected_exit_code: 0

  - name: Alternative color coding
    description: Use mid segment for color coding
    command: /opt/trackvis-0.6.1/track_vis test_output/synthetic_tracks.trk -cc -nr -disable_log 2>&1
    expected_exit_code: 0

  - name: Helix color coding
    description: Use helix angle for color coding
    command: /opt/trackvis-0.6.1/track_vis test_output/synthetic_tracks.trk -helix 0 0 1 80 96 96 -nr -disable_log 2>&1
    expected_exit_code: 0

  - name: Axis thickness
    description: Set helix axis thickness
    command: /opt/trackvis-0.6.1/track_vis test_output/synthetic_tracks.trk -helix 0 0 1 80 96 96 -at 2 -nr -disable_log 2>&1
    expected_exit_code: 0

  # ==========================================================================
  # BRAIN IMAGE OVERLAY
  # ==========================================================================
  - name: Brain image overlay
    description: Load brain image as background
    command: /opt/trackvis-0.6.1/track_vis test_output/synthetic_tracks.trk -b ${t1w} -nr -disable_log 2>&1
    expected_exit_code: 0

  - name: Axial brain slice
    description: Display specific axial brain slice
    command: /opt/trackvis-0.6.1/track_vis test_output/synthetic_tracks.trk -b ${t1w} -bz 96 -nr -disable_log 2>&1
    expected_exit_code: 0

  - name: Sagittal brain slice
    description: Display specific sagittal brain slice
    command: /opt/trackvis-0.6.1/track_vis test_output/synthetic_tracks.trk -b ${t1w} -bx 80 -nr -disable_log 2>&1
    expected_exit_code: 0

  - name: Coronal brain slice
    description: Display specific coronal brain slice
    command: /opt/trackvis-0.6.1/track_vis test_output/synthetic_tracks.trk -b ${t1w} -by 96 -nr -disable_log 2>&1
    expected_exit_code: 0

  - name: Window level adjustment
    description: Set window level for brain display
    command: /opt/trackvis-0.6.1/track_vis test_output/synthetic_tracks.trk -b ${t1w} -bz 96 -w 0 500 -nr -disable_log 2>&1
    expected_exit_code: 0

  # ==========================================================================
  # ROI FILE OPERATIONS
  # ==========================================================================
  - name: ROI from NIfTI file
    description: Filter tracks using NIfTI ROI mask
    command: /opt/trackvis-0.6.1/track_vis test_output/synthetic_tracks.trk -roi ${t1w} 100 10000 -nr -disable_log 2>&1
    expected_exit_code: 0

  - name: Dual ROI files
    description: Filter tracks passing through two ROI regions
    command: /opt/trackvis-0.6.1/track_vis test_output/synthetic_tracks.trk -roi ${t1w} 100 10000 -roi2 ${t1w} 50 5000 -nr -disable_log 2>&1
    expected_exit_code: 0

  - name: Output ROI volume
    description: Output ROI region to volume
    command: /opt/trackvis-0.6.1/track_vis test_output/synthetic_tracks.trk -roi_pt 80 96 96 10 0 -o_roi test_output/roi_output.nii.gz -nr -disable_log 2>&1
    validate:
      - output_exists: ${output_dir}/roi_output.nii.gz

  - name: ROI display with tracks
    description: Display ROI overlays
    command: /opt/trackvis-0.6.1/track_vis test_output/synthetic_tracks.trk -rois ${t1w} 200 -nr -disable_log 2>&1
    expected_exit_code: 0

  # ==========================================================================
  # BACKGROUND TRACKS
  # ==========================================================================
  - name: Background tracks
    description: Display second track file as background
    command: /opt/trackvis-0.6.1/track_vis test_output/synthetic_tracks.trk -bg test_output/synthetic_tracks2.trk -nr -disable_log 2>&1
    expected_exit_code: 0

  # ==========================================================================
  # END POINT ROI FILTERING
  # ==========================================================================
  - name: End ROI filter
    description: Filter tracks ending in ROI
    command: /opt/trackvis-0.6.1/track_vis test_output/synthetic_tracks.trk -roi_end ${t1w} 100 10000 0 -nr -disable_log 2>&1
    expected_exit_code: 0

  - name: Both ends ROI filter
    description: Filter tracks with both ends in ROI
    command: /opt/trackvis-0.6.1/track_vis test_output/synthetic_tracks.trk -roi_end ${t1w} 100 10000 1 -nr -disable_log 2>&1
    expected_exit_code: 0

  - name: End point iteration
    description: Use end points as ROI for filtering
    command: /opt/trackvis-0.6.1/track_vis test_output/synthetic_tracks.trk -roi_pt 80 96 96 10 1 -end_pt 1 -nr -disable_log 2>&1
    expected_exit_code: 0

  # ==========================================================================
  # TUBE ROI FILTERING
  # ==========================================================================
  - name: ROI tube filter
    description: Use track to construct tube ROI
    command: /opt/trackvis-0.6.1/track_vis test_output/synthetic_tracks.trk -roi_tube 2 45 5 1 1 -nr -disable_log 2>&1
    expected_exit_code: 0

  # ==========================================================================
  # SCREEN CAPTURE (batch mode)
  # ==========================================================================
  - name: Screen capture single
    description: Capture single screen to image
    command: /opt/trackvis-0.6.1/track_vis test_output/synthetic_tracks.trk -sc test_output/capture.png -disable_log 2>&1 || true
    # Note: May fail without display, testing command parsing
    expected_exit_code: 0

  - name: Screen capture magnification
    description: Test magnification option parsing
    command: /opt/trackvis-0.6.1/track_vis test_output/synthetic_tracks.trk -mag 2 -nr -disable_log 2>&1
    expected_exit_code: 0

  # ==========================================================================
  # LOG OPTIONS
  # ==========================================================================
  - name: Custom log ID
    description: Set custom log ID string
    command: /opt/trackvis-0.6.1/track_vis test_output/synthetic_tracks.trk -log test_run -nr -disable_log 2>&1
    expected_exit_code: 0

  - name: Disable log
    description: Disable command-line logging
    command: /opt/trackvis-0.6.1/track_vis test_output/synthetic_tracks.trk -disable_log -nr 2>&1
    expected_exit_code: 0

  # ==========================================================================
  # DUPLICATE OPTION (for multiple track files)
  # ==========================================================================
  - name: Duplicate arguments
    description: Apply same arguments to multiple track files
    command: /opt/trackvis-0.6.1/track_vis test_output/synthetic_tracks.trk -bg test_output/synthetic_tracks2.trk -dup -nr -disable_log 2>&1
    expected_exit_code: 0

  # ==========================================================================
  # COMBINED FILTERING PIPELINES
  # ==========================================================================
  - name: Complex filter pipeline
    description: Combine multiple filtering options
    command: /opt/trackvis-0.6.1/track_vis test_output/synthetic_tracks.trk -l 10 500 -nx 70 100 -u -0.8 0.8 -o test_output/tracks_complex.trk -nr -disable_log 2>&1
    validate:
      - output_exists: ${output_dir}/tracks_complex.trk

  - name: Filter with brain overlay
    description: Filter tracks with brain image display
    command: /opt/trackvis-0.6.1/track_vis test_output/synthetic_tracks.trk -l 5 1000 -b ${t1w} -bz 96 -w 0 500 -nr -disable_log 2>&1
    expected_exit_code: 0

  - name: Filter with ROI and output
    description: Filter by ROI pointer and save volume
    command: /opt/trackvis-0.6.1/track_vis test_output/synthetic_tracks.trk -roi_pt 80 96 96 15 1 -ov test_output/roi_filtered_vol.nii.gz -nr -disable_log 2>&1
    validate:
      - output_exists: ${output_dir}/roi_filtered_vol.nii.gz

  - name: Full display pipeline
    description: Combine display options (no render)
    command: /opt/trackvis-0.6.1/track_vis test_output/synthetic_tracks.trk -dc -s -r 0.08 -ns 6 -bc 0.2 0.2 0.2 -box -nr -disable_log 2>&1
    expected_exit_code: 0

  # ==========================================================================
  # SURFACE FILE OPTIONS
  # ==========================================================================
  - name: Surface file generation
    description: Generate surface from volume
    command: /opt/trackvis-0.6.1/track_vis test_output/synthetic_tracks.trk -sf ${t1w} 0.5 -nr -disable_log 2>&1
    expected_exit_code: 0

  - name: Surface threshold
    description: Set threshold for surface generation
    command: /opt/trackvis-0.6.1/track_vis test_output/synthetic_tracks.trk -sf ${t1w} 0.5 -sf_th 100 -nr -disable_log 2>&1
    expected_exit_code: 0

  # ==========================================================================
  # LATTICE ROI
  # ==========================================================================
  - name: Lattice ROI filter
    description: Apply lattice-shaped ROI filtering
    command: /opt/trackvis-0.6.1/track_vis test_output/synthetic_tracks.trk -roi ${t1w} 100 10000 -lattice 2 2 2 5 5 5 0 0 0 -nr -disable_log 2>&1
    expected_exit_code: 0

  # ==========================================================================
  # KT (CURVATURE * TORSION) FILTERING
  # ==========================================================================
  - name: KT threshold
    description: Filter by curvature times torsion
    command: /opt/trackvis-0.6.1/track_vis test_output/synthetic_tracks.trk -kt -1 1 -nr -disable_log 2>&1
    expected_exit_code: 0

  # ==========================================================================
  # ERROR HANDLING
  # ==========================================================================
  - name: Missing track file error
    description: Test error handling for missing file
    command: /opt/trackvis-0.6.1/track_vis nonexistent.trk -nr 2>&1 || echo "Expected error for missing file"
    expected_output_contains: "error"

  - name: Invalid option handling
    description: Test handling of invalid options
    command: /opt/trackvis-0.6.1/track_vis test_output/synthetic_tracks.trk --invalid-option 2>&1 || echo "Invalid option handled"
    expected_exit_code: 0

cleanup:
  script: |
    #!/usr/bin/env bash
    # Optionally remove test outputs
    # rm -rf test_output
    echo "Test outputs preserved in test_output/"
    echo "Synthetic track files: test_output/synthetic_tracks.trk, test_output/synthetic_tracks2.trk"
