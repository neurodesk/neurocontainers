# ilastik container test suite
# Tests for ilastik v1.4.0 - interactive machine learning for (bio)image analysis
#
# ilastik is a tool for interactive image classification, segmentation, and analysis
# It provides workflows for:
#   - Pixel Classification: supervised pixel-level classification
#   - Object Classification: classify segmented objects
#   - Autocontext: iterative pixel classification
#   - Counting: cell density counting
#   - Tracking: object tracking in time series
#   - Carving: semi-automatic 3D segmentation
#   - Multicut: boundary-based segmentation
#   - Neural Network: deep learning-based classification
#
# Citation:
#   ilastik: interactive machine learning for (bio)image analysis
#   Stuart Berg et al., Nature Methods, (2019)
#
# Note: Most tests are for headless/batch mode. GUI tests require display.
# Many tests require pre-trained project files (.ilp) for actual processing.

name: ilastik
version: 1.4.0
container: ilastik_1.4.0_20230720.simg

test_data:
  # ilastik works with various image formats
  # For testing, we use placeholder paths - actual test data should be provided
  output_dir: test_output

setup:
  script: |
    #!/usr/bin/env bash
    set -e
    mkdir -p test_output

tests:
  # ==========================================================================
  # BASIC FUNCTIONALITY AND VERSION CHECKS
  # ==========================================================================
  - name: Version check
    description: Verify ilastik reports correct version
    command: run_ilastik.sh --version 2>&1
    expected_output_contains: "1.4.0"

  - name: Help message
    description: Display main help message
    command: run_ilastik.sh --help 2>&1
    expected_output_contains: "start an ilastik workflow"

  - name: Help shows headless option
    description: Verify headless mode option is available
    command: run_ilastik.sh --help 2>&1
    expected_output_contains: "--headless"

  - name: Help shows project option
    description: Verify project file option is available
    command: run_ilastik.sh --help 2>&1
    expected_output_contains: "--project"

  - name: Help shows workflow option
    description: Verify workflow option is available
    command: run_ilastik.sh --help 2>&1
    expected_output_contains: "--workflow"

  - name: Help shows new_project option
    description: Verify new project creation option
    command: run_ilastik.sh --help 2>&1
    expected_output_contains: "--new_project"

  - name: Help shows readonly option
    description: Verify readonly mode option
    command: run_ilastik.sh --help 2>&1
    expected_output_contains: "--readonly"

  - name: Help shows debug option
    description: Verify debug mode option
    command: run_ilastik.sh --help 2>&1
    expected_output_contains: "--debug"

  - name: Help shows logfile option
    description: Verify logfile option is available
    command: run_ilastik.sh --help 2>&1
    expected_output_contains: "--logfile"

  - name: Help shows configfile option
    description: Verify custom config file option
    command: run_ilastik.sh --help 2>&1
    expected_output_contains: "--configfile"

  - name: Help shows redirect_output option
    description: Verify output redirection option
    command: run_ilastik.sh --help 2>&1
    expected_output_contains: "--redirect_output"

  - name: Help shows exit_on_failure option
    description: Verify exit on failure option
    command: run_ilastik.sh --help 2>&1
    expected_output_contains: "--exit_on_failure"

  - name: Help shows neural network device option
    description: Verify NN device option for GPU/CPU selection
    command: run_ilastik.sh --help 2>&1
    expected_output_contains: "--nn_device"

  - name: Help shows tiktorch option
    description: Verify tiktorch server path option
    command: run_ilastik.sh --help 2>&1
    expected_output_contains: "--tiktorch_executable"

  # ==========================================================================
  # ILASTIK SCRIPT AND ENVIRONMENT
  # ==========================================================================
  - name: Run ilastik script exists
    description: Verify run_ilastik.sh script is accessible
    command: which run_ilastik.sh 2>&1
    expected_output_contains: "run_ilastik.sh"

  - name: Python environment check
    description: Verify ilastik Python environment is configured
    command: ls /opt/ilastik-1.4.0-Linux/bin/python 2>&1
    expected_output_contains: "python"

  - name: Ilastik binary exists
    description: Verify ilastik entry point script exists
    command: ls /opt/ilastik-1.4.0-Linux/bin/ilastik 2>&1
    expected_output_contains: "ilastik"

  # ==========================================================================
  # HEADLESS MODE ERROR HANDLING
  # ==========================================================================
  - name: Headless mode without project error
    description: Test error when running headless without project file
    command: run_ilastik.sh --headless 2>&1 || true
    expected_output_contains: ""
    expected_exit_code: 0

  - name: Missing project file error
    description: Test error handling for non-existent project file
    command: run_ilastik.sh --headless --project nonexistent.ilp 2>&1 || true
    expected_output_contains: ""

  - name: New project requires workflow
    description: Test that new_project requires workflow specification
    command: run_ilastik.sh --headless --new_project test.ilp 2>&1 || true
    expected_output_contains: ""

  # ==========================================================================
  # WORKFLOW TYPE CHECKS (via help/documentation)
  # ==========================================================================
  - name: Pixel Classification workflow available
    description: Verify Pixel Classification workflow module exists
    command: ls /opt/ilastik-1.4.0-Linux/lib/python3.7/site-packages/ilastik/workflows/pixelClassification/ 2>&1
    expected_output_contains: "pixelClassificationWorkflow.py"

  - name: Object Classification workflow available
    description: Verify Object Classification workflow module exists
    command: ls /opt/ilastik-1.4.0-Linux/lib/python3.7/site-packages/ilastik/workflows/objectClassification/ 2>&1
    expected_output_contains: "objectClassificationWorkflow.py"

  - name: Autocontext workflow available
    description: Verify Autocontext workflow module exists
    command: ls /opt/ilastik-1.4.0-Linux/lib/python3.7/site-packages/ilastik/workflows/newAutocontext/ 2>&1
    expected_output_contains: "newAutocontextWorkflow.py"

  - name: Counting workflow available
    description: Verify Counting workflow module exists
    command: ls /opt/ilastik-1.4.0-Linux/lib/python3.7/site-packages/ilastik/workflows/counting/ 2>&1
    expected_output_contains: "countingWorkflow.py"

  - name: Carving workflow available
    description: Verify Carving workflow module exists
    command: ls /opt/ilastik-1.4.0-Linux/lib/python3.7/site-packages/ilastik/workflows/carving/ 2>&1
    expected_output_contains: "carvingWorkflow.py"

  - name: Tracking workflow available
    description: Verify Tracking workflow modules exist
    command: ls /opt/ilastik-1.4.0-Linux/lib/python3.7/site-packages/ilastik/workflows/tracking/ 2>&1
    expected_output_contains: "manual"

  - name: Multicut workflow available
    description: Verify Edge Training with Multicut workflow exists
    command: ls /opt/ilastik-1.4.0-Linux/lib/python3.7/site-packages/ilastik/workflows/edgeTrainingWithMulticut/ 2>&1
    expected_output_contains: "edgeTrainingWithMulticutWorkflow.py"

  - name: Neural Network workflow available
    description: Verify Neural Network workflow modules exist
    command: ls /opt/ilastik-1.4.0-Linux/lib/python3.7/site-packages/ilastik/workflows/neuralNetwork/ 2>&1
    expected_output_contains: "_nnWorkflowBase.py"

  - name: Data Conversion workflow available
    description: Verify Data Conversion workflow exists
    command: ls /opt/ilastik-1.4.0-Linux/lib/python3.7/site-packages/ilastik/workflows/examples/dataConversion/ 2>&1
    expected_output_contains: "dataConversionWorkflow.py"

  # ==========================================================================
  # APPLET AVAILABILITY CHECKS
  # ==========================================================================
  - name: Data Selection applet available
    description: Verify Data Selection applet exists
    command: ls /opt/ilastik-1.4.0-Linux/lib/python3.7/site-packages/ilastik/applets/dataSelection/ 2>&1
    expected_output_contains: "dataSelectionApplet.py"

  - name: Feature Selection applet available
    description: Verify Feature Selection applet exists
    command: ls /opt/ilastik-1.4.0-Linux/lib/python3.7/site-packages/ilastik/applets/featureSelection/ 2>&1
    expected_output_contains: "featureSelectionApplet.py"

  - name: Pixel Classification applet available
    description: Verify Pixel Classification applet exists
    command: ls /opt/ilastik-1.4.0-Linux/lib/python3.7/site-packages/ilastik/applets/pixelClassification/ 2>&1
    expected_output_contains: "pixelClassificationApplet.py"

  - name: Object Classification applet available
    description: Verify Object Classification applet exists
    command: ls /opt/ilastik-1.4.0-Linux/lib/python3.7/site-packages/ilastik/applets/objectClassification/ 2>&1
    expected_output_contains: "objectClassificationApplet.py"

  - name: Object Extraction applet available
    description: Verify Object Extraction applet exists
    command: ls /opt/ilastik-1.4.0-Linux/lib/python3.7/site-packages/ilastik/applets/objectExtraction/ 2>&1
    expected_output_contains: "objectExtractionApplet.py"

  - name: Data Export applet available
    description: Verify Data Export applet exists
    command: ls /opt/ilastik-1.4.0-Linux/lib/python3.7/site-packages/ilastik/applets/dataExport/ 2>&1
    expected_output_contains: "dataExportApplet.py"

  - name: Batch Processing applet available
    description: Verify Batch Processing applet exists
    command: ls /opt/ilastik-1.4.0-Linux/lib/python3.7/site-packages/ilastik/applets/batchProcessing/ 2>&1
    expected_output_contains: "batchProcessingApplet.py"

  - name: Labeling applet available
    description: Verify Labeling applet exists
    command: ls /opt/ilastik-1.4.0-Linux/lib/python3.7/site-packages/ilastik/applets/labeling/ 2>&1
    expected_output_contains: "labelingApplet.py"

  - name: Threshold applet available
    description: Verify Threshold Two Levels applet exists
    command: ls /opt/ilastik-1.4.0-Linux/lib/python3.7/site-packages/ilastik/applets/thresholdTwoLevels/ 2>&1
    expected_output_contains: "thresholdTwoLevelsApplet.py"

  - name: Counting applet available
    description: Verify Counting applet exists
    command: ls /opt/ilastik-1.4.0-Linux/lib/python3.7/site-packages/ilastik/applets/counting/ 2>&1
    expected_output_contains: "countingApplet.py"

  - name: Neural Network applet available
    description: Verify Neural Network applet exists
    command: ls /opt/ilastik-1.4.0-Linux/lib/python3.7/site-packages/ilastik/applets/neuralNetwork/ 2>&1
    expected_output_contains: "nnClassApplet"

  - name: Tracking applet available
    description: Verify Tracking feature extraction applet exists
    command: ls /opt/ilastik-1.4.0-Linux/lib/python3.7/site-packages/ilastik/applets/trackingFeatureExtraction/ 2>&1
    expected_output_contains: ""

  - name: Multicut applet available
    description: Verify Multicut applet exists
    command: ls /opt/ilastik-1.4.0-Linux/lib/python3.7/site-packages/ilastik/applets/multicut/ 2>&1
    expected_output_contains: "multicutApplet.py"

  - name: Edge Training applet available
    description: Verify Edge Training applet exists
    command: ls /opt/ilastik-1.4.0-Linux/lib/python3.7/site-packages/ilastik/applets/edgeTraining/ 2>&1
    expected_output_contains: "edgeTrainingApplet.py"

  - name: WSDT applet available
    description: Verify Watershed applet exists
    command: ls /opt/ilastik-1.4.0-Linux/lib/python3.7/site-packages/ilastik/applets/wsdt/ 2>&1
    expected_output_contains: "wsdtApplet.py"

  # ==========================================================================
  # LIBRARY AND DEPENDENCY CHECKS
  # ==========================================================================
  - name: Vigra library available
    description: Verify vigra image processing library is available
    command: ls /opt/ilastik-1.4.0-Linux/lib/python3.7/site-packages/vigra/ 2>&1
    expected_output_contains: "__init__.py"

  - name: Lazyflow library available
    description: Verify lazyflow framework is available
    command: ls /opt/ilastik-1.4.0-Linux/lib/python3.7/site-packages/lazyflow/ 2>&1
    expected_output_contains: "__init__.py"

  - name: NumPy available
    description: Verify NumPy is available
    command: ls /opt/ilastik-1.4.0-Linux/lib/python3.7/site-packages/numpy/ 2>&1
    expected_output_contains: "__init__.py"

  - name: H5py available
    description: Verify HDF5 Python library is available
    command: ls /opt/ilastik-1.4.0-Linux/lib/python3.7/site-packages/h5py/ 2>&1
    expected_output_contains: "__init__.py"

  - name: Scikit-learn available
    description: Verify scikit-learn is available
    command: ls /opt/ilastik-1.4.0-Linux/lib/python3.7/site-packages/sklearn/ 2>&1
    expected_output_contains: "__init__.py"

  - name: Z5py available for N5 support
    description: Verify z5py library for N5 format support
    command: ls /opt/ilastik-1.4.0-Linux/lib/python3.7/site-packages/z5py/ 2>&1
    expected_output_contains: "__init__.py"

  - name: Tifffile available
    description: Verify tifffile library for TIFF support
    command: ls /opt/ilastik-1.4.0-Linux/lib/python3.7/site-packages/tifffile/ 2>&1
    expected_output_contains: "__init__.py"

  - name: BioImageIO available
    description: Verify BioImage.IO model spec support via Python import
    command: /opt/ilastik-1.4.0-Linux/bin/python -c "import bioimageio; print('bioimageio available')" 2>&1
    expected_output_contains: "bioimageio available"

  - name: ONNX runtime check
    description: Check if ONNX support is available (not installed in this build)
    command: /opt/ilastik-1.4.0-Linux/bin/python -c "import onnxruntime; print('onnx available')" 2>&1 || echo "ONNX not installed in this build"
    expected_output_contains: "ONNX not installed"

  # ==========================================================================
  # FILE FORMAT SUPPORT CHECKS
  # ==========================================================================
  - name: HDF5 format export support
    description: Verify HDF5 export is supported
    command: grep -r "hdf5" /opt/ilastik-1.4.0-Linux/lib/python3.7/site-packages/lazyflow/operators/ioOperators/opExportSlot.py 2>&1 | head -1
    expected_output_contains: "hdf5"

  - name: N5 format export support
    description: Verify N5 export is supported
    command: grep -r '"n5"' /opt/ilastik-1.4.0-Linux/lib/python3.7/site-packages/lazyflow/operators/ioOperators/opExportSlot.py 2>&1 | head -1
    expected_output_contains: "n5"

  - name: TIFF format export support
    description: Verify TIFF export is supported
    command: grep -r "tiff" /opt/ilastik-1.4.0-Linux/lib/python3.7/site-packages/lazyflow/operators/ioOperators/opExportSlot.py 2>&1 | head -1
    expected_output_contains: "tiff"

  - name: NumPy format export support
    description: Verify NumPy export is supported
    command: grep -r '"numpy"' /opt/ilastik-1.4.0-Linux/lib/python3.7/site-packages/lazyflow/operators/ioOperators/opExportSlot.py 2>&1 | head -1
    expected_output_contains: "numpy"

  - name: PNG format support via vigra
    description: Verify PNG is in supported extensions
    command: ls /opt/ilastik-1.4.0-Linux/lib/libpng*.so* 2>&1 | head -1
    expected_output_contains: "libpng"

  # ==========================================================================
  # PLUGIN SYSTEM CHECKS
  # ==========================================================================
  - name: Plugin manager available
    description: Verify ilastik plugin system is importable
    command: /opt/ilastik-1.4.0-Linux/bin/python -c "import ilastik.plugins; print('plugins module available')" 2>&1
    expected_output_contains: "plugins module available"

  - name: Feature plugin base available
    description: Verify ilastik applets can be imported
    command: /opt/ilastik-1.4.0-Linux/bin/python -c "import ilastik.applets; print('applets module available')" 2>&1
    expected_output_contains: "applets module available"

  # ==========================================================================
  # ILASTIK CONFIGURATION
  # ==========================================================================
  - name: Config module available
    description: Verify ilastik config module exists
    command: ls /opt/ilastik-1.4.0-Linux/lib/python3.7/site-packages/ilastik/config.py 2>&1
    expected_output_contains: "config.py"

  - name: Shell module available
    description: Verify ilastik shell module exists
    command: ls /opt/ilastik-1.4.0-Linux/lib/python3.7/site-packages/ilastik/shell/ 2>&1
    expected_output_contains: "__init__.py"

  # ==========================================================================
  # ILASTIK TOOLS AND UTILITIES
  # ==========================================================================
  - name: Ilastik tools module available
    description: Verify ilastiktools package exists
    command: ls /opt/ilastik-1.4.0-Linux/lib/python3.7/site-packages/ilastiktools/ 2>&1
    expected_output_contains: "__init__.py"

  - name: Ilastik RAG module available
    description: Verify ilastikrag (region adjacency graph) package exists
    command: ls /opt/ilastik-1.4.0-Linux/lib/python3.7/site-packages/ilastikrag/ 2>&1
    expected_output_contains: "__init__.py"

  - name: Ilastik feature selection module available
    description: Verify ilastik feature selection package exists
    command: ls /opt/ilastik-1.4.0-Linux/lib/python3.7/site-packages/ilastik_feature_selection/ 2>&1
    expected_output_contains: "__init__.py"

  - name: ELF ilastik integration available
    description: Verify ELF (EMBL Segmentation Library) ilastik integration
    command: ls /opt/ilastik-1.4.0-Linux/lib/python3.7/site-packages/elf/ilastik/ 2>&1
    expected_output_contains: "__init__.py"

  # ==========================================================================
  # DOCUMENTATION AND LICENSE
  # ==========================================================================
  - name: README available
    description: Verify README documentation is available
    command: cat /README.md 2>&1 | head -5
    expected_output_contains: "ilastik"

  - name: License file available
    description: Verify license file exists
    command: ls /opt/ilastik-1.4.0-Linux/LICENSE.txt 2>&1
    expected_output_contains: "LICENSE.txt"

  # ==========================================================================
  # ADVANCED HEADLESS MODE OPTIONS
  # ==========================================================================
  - name: Help shows HBP option
    description: Verify Human Brain Project mode option
    command: run_ilastik.sh --help 2>&1
    expected_output_contains: "--hbp"

  - name: Help shows fullscreen option
    description: Verify fullscreen mode option (GUI)
    command: run_ilastik.sh --help 2>&1
    expected_output_contains: "--fullscreen"

  - name: Help shows process_name option
    description: Verify process name option for logging
    command: run_ilastik.sh --help 2>&1
    expected_output_contains: "--process_name"

  - name: Help shows clean_paths option
    description: Verify clean paths option
    command: run_ilastik.sh --help 2>&1
    expected_output_contains: "--clean_paths"

  # ==========================================================================
  # FEATURE COMPUTATION CAPABILITIES
  # ==========================================================================
  - name: Feature Selection operator available
    description: Verify feature selection operator exists
    command: ls /opt/ilastik-1.4.0-Linux/lib/python3.7/site-packages/ilastik/applets/featureSelection/opFeatureSelection.py 2>&1
    expected_output_contains: "opFeatureSelection.py"

  - name: Gaussian smoothing features available
    description: Verify Gaussian smoothing feature computation
    command: grep -l "GaussianSmoothing" /opt/ilastik-1.4.0-Linux/lib/python3.7/site-packages/ilastik/applets/featureSelection/*.py 2>&1 | head -1
    expected_output_contains: ".py"

  # ==========================================================================
  # CLASSIFIER CHECKS
  # ==========================================================================
  - name: Random Forest classifier available
    description: Verify Vigra Random Forest is available
    command: grep -l "RandomForest" /opt/ilastik-1.4.0-Linux/lib/python3.7/site-packages/ilastik/applets/pixelClassification/*.py 2>&1 | head -1
    expected_output_contains: ".py"

  # ==========================================================================
  # OPERATOR INFRASTRUCTURE
  # ==========================================================================
  - name: Lazyflow operators available
    description: Verify lazyflow operator infrastructure
    command: ls /opt/ilastik-1.4.0-Linux/lib/python3.7/site-packages/lazyflow/operators/ 2>&1
    expected_output_contains: "__init__.py"

  - name: IO operators available
    description: Verify I/O operators for file handling
    command: ls /opt/ilastik-1.4.0-Linux/lib/python3.7/site-packages/lazyflow/operators/ioOperators/ 2>&1
    expected_output_contains: "__init__.py"

  - name: Generic operators available
    description: Verify generic operators
    command: ls /opt/ilastik-1.4.0-Linux/lib/python3.7/site-packages/lazyflow/operators/generic.py 2>&1
    expected_output_contains: "generic.py"

  # ==========================================================================
  # SERIALIZATION CHECKS
  # ==========================================================================
  - name: Project serializer available
    description: Verify project serialization module exists
    command: ls /opt/ilastik-1.4.0-Linux/lib/python3.7/site-packages/ilastik/applets/dataSelection/dataSelectionSerializer.py 2>&1
    expected_output_contains: "dataSelectionSerializer.py"

  - name: Data export serializer available
    description: Verify data export serialization
    command: ls /opt/ilastik-1.4.0-Linux/lib/python3.7/site-packages/ilastik/applets/dataExport/dataExportSerializer.py 2>&1
    expected_output_contains: "dataExportSerializer.py"

  # ==========================================================================
  # CONSERVATION TRACKING WORKFLOW
  # ==========================================================================
  - name: Conservation tracking available
    description: Verify conservation tracking workflow exists
    command: ls /opt/ilastik-1.4.0-Linux/lib/python3.7/site-packages/ilastik/workflows/tracking/conservation/ 2>&1
    expected_output_contains: "conservationTrackingWorkflow.py"

  - name: Animal tracking available
    description: Verify animal conservation tracking workflow exists
    command: ls /opt/ilastik-1.4.0-Linux/lib/python3.7/site-packages/ilastik/workflows/tracking/conservation/ 2>&1
    expected_output_contains: "animalConservationTrackingWorkflow.py"

  - name: Manual tracking available
    description: Verify manual tracking workflow exists
    command: ls /opt/ilastik-1.4.0-Linux/lib/python3.7/site-packages/ilastik/workflows/tracking/manual/ 2>&1
    expected_output_contains: "manualTrackingWorkflow.py"

  - name: Structured tracking available
    description: Verify structured tracking workflow exists
    command: ls /opt/ilastik-1.4.0-Linux/lib/python3.7/site-packages/ilastik/workflows/tracking/structured/ 2>&1
    expected_output_contains: "structuredTrackingWorkflow.py"

  # ==========================================================================
  # GUI COMPONENTS (existence check only - cannot test without display)
  # ==========================================================================
  - name: Qt libraries available
    description: Verify Qt libraries are available
    command: ls /opt/ilastik-1.4.0-Linux/plugins/platforms/ 2>&1
    expected_output_contains: ""

  - name: GUI shell available
    description: Verify ilastik GUI shell module exists
    command: ls /opt/ilastik-1.4.0-Linux/lib/python3.7/site-packages/ilastik/shell/gui/ 2>&1
    expected_output_contains: "__init__.py"

  # ==========================================================================
  # UTILITY MODULES
  # ==========================================================================
  - name: Command line processing utilities available
    description: Verify CLI processing utilities exist
    command: ls /opt/ilastik-1.4.0-Linux/lib/python3.7/site-packages/ilastik/utility/commandLineProcessing.py 2>&1
    expected_output_contains: "commandLineProcessing.py"

  - name: OpMultiLaneWrapper available
    description: Verify multi-lane operator wrapper exists
    command: ls /opt/ilastik-1.4.0-Linux/lib/python3.7/site-packages/ilastik/utility/opMultiLaneWrapper.py 2>&1
    expected_output_contains: "opMultiLaneWrapper.py"

cleanup:
  script: |
    #!/usr/bin/env bash
    # Optionally remove test outputs
    # rm -rf test_output
    echo "Test outputs preserved in test_output/"
