tests:
  - name: Test spinalcordtoolbox
    manual: true
    script: |
      bash /opt/spinalcordtoolbox-7.2/batch_processing.sh
  - name: Test spinalcordtoolbox for OpenRecon
    manual: true
    script: |
      # build:
      source .venv/bin/activate
      ./builder/build.py generate spinalcordtoolbox --recreate --build --login --architecture x86_64

      # check that the CUDA version is valid for MARS: has to be CUDA 11.x
      python -c "import torch; print(torch.version.cuda)"

      # Convert NIFTI to ISMRMRD format
      rm /buildhostdirectory/input_fromNIFTI.h5
      python3 /opt/code/python-ismrmrd-server/nifti2mrd.py \
        -i /buildhostdirectory/t2_Se1_Res0.8_0.8_Spac0.8.nii.gz \
        -o /buildhostdirectory/input_fromNIFTI.h5
      
      rm /buildhostdirectory/input_fromNIFTI_lesion.h5
      python3 /opt/code/python-ismrmrd-server/nifti2mrd.py \
        -i /buildhostdirectory/t2lesion_Se1_Res0.8_0.8_Spac0.8.nii.gz \
        -o /buildhostdirectory/input_fromNIFTI_lesion.h5

      # Start OpenRecon server
      python3 /opt/code/python-ismrmrd-server/main.py -v -r -H=0.0.0.0 -p=9002 -s -S=/tmp/share/saved_data &
      sleep 2

      rm /buildhostdirectory/output.h5
      python3 /opt/code/python-ismrmrd-server/client.py \
        -G dataset \
        -o /buildhostdirectory/output.h5 \
        /buildhostdirectory/input_fromNIFTI_lesion.h5 \
        -c spinalcordtoolbox

      # Check output h5 data in "H5Web" VS code plugin viewer

      # check for wasted space in the image:
      docker run --rm -it -v /var/run/docker.sock:/var/run/docker.sock wagoodman/dive:latest spinalcordtoolbox:latest